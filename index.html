import React, { useState } from 'react';
import { Checkbox } from '@/components/ui/checkbox';
import { Button } from '@/components/ui/button';
import { Input } from '@/components/ui/input';
import { Badge } from '@/components/ui/badge';
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from '@/components/ui/select';
import { Popover, PopoverContent, PopoverTrigger } from '@/components/ui/popover';
import { Calendar as CalendarComponent } from '@/components/ui/calendar';
import { Calendar, ChevronDown, ChevronRight, Plus, Trash2, Edit2, Check, X } from 'lucide-react';
import { format } from 'date-fns';
import { cn } from '@/lib/utils';

export interface Subtask {
  id: string;
  title: string;
  completed: boolean;
}

export interface Task {
  id: string;
  title: string;
  completed: boolean;
  priority: 'low' | 'medium' | 'high';
  dueDate?: Date;
  subtasks: Subtask[];
}

interface TaskProps {
  task: Task;
  onUpdate: (task: Task) => void;
  onDelete: (id: string) => void;
}

export const Task: React.FC<TaskProps> = ({ task, onUpdate, onDelete }) => {
  const [isExpanded, setIsExpanded] = useState(false);
  const [newSubtaskTitle, setNewSubtaskTitle] = useState('');
  const [isAddingSubtask, setIsAddingSubtask] = useState(false);
  const [isEditing, setIsEditing] = useState(false);
  const [editTitle, setEditTitle] = useState(task.title);
  const [editPriority, setEditPriority] = useState(task.priority);
  const [editDueDate, setEditDueDate] = useState<Date | undefined>(task.dueDate);
  const [isCalendarOpen, setIsCalendarOpen] = useState(false);

  const handleToggleComplete = () => {
    onUpdate({ ...task, completed: !task.completed });
  };

  const handleSubtaskToggle = (subtaskId: string) => {
    const updatedSubtasks = task.subtasks.map(subtask =>
      subtask.id === subtaskId
        ? { ...subtask, completed: !subtask.completed }
        : subtask
    );
    onUpdate({ ...task, subtasks: updatedSubtasks });
  };

  const handleAddSubtask = () => {
    if (newSubtaskTitle.trim()) {
      const newSubtask: Subtask = {
        id: Date.now().toString(),
        title: newSubtaskTitle.trim(),
        completed: false
      };
      onUpdate({ ...task, subtasks: [...task.subtasks, newSubtask] });
      setNewSubtaskTitle('');
      setIsAddingSubtask(false);
    }
  };

  const handleDeleteSubtask = (subtaskId: string) => {
    const updatedSubtasks = task.subtasks.filter(subtask => subtask.id !== subtaskId);
    onUpdate({ ...task, subtasks: updatedSubtasks });
  };

  const handleStartEdit = () => {
    setIsEditing(true);
    setEditTitle(task.title);
    setEditPriority(task.priority);
    setEditDueDate(task.dueDate);
  };

  const handleSaveEdit = () => {
    onUpdate({
      ...task,
      title: editTitle.trim() || task.title,
      priority: editPriority,
      dueDate: editDueDate
    });
    setIsEditing(false);
  };

  const handleCancelEdit = () => {
    setIsEditing(false);
    setEditTitle(task.title);
    setEditPriority(task.priority);
    setEditDueDate(task.dueDate);
  };

  const completedSubtasks = task.subtasks.filter(subtask => subtask.completed).length;
  const totalSubtasks = task.subtasks.length;

  const getPriorityDotClass = (priority: string) => {
    switch (priority) {
      case 'high': return 'priority-dot-high';
      case 'medium': return 'priority-dot-medium';
      case 'low': return 'priority-dot-low';
      default: return 'priority-dot-low';
    }
  };

  return (
    <div className={cn(
      'task-card p-4 mb-3',
      task.completed && 'task-card-completed'
    )}>
      <div className="flex items-start gap-3">
        <Checkbox
          checked={task.completed}
          onCheckedChange={handleToggleComplete}
          className="mt-1"
        />
        
        <div className="flex-1 min-w-0">
          {isEditing ? (
            <div className="space-y-3">
              {/* Edit Title */}
              <div className="flex items-center gap-2">
                <div className={getPriorityDotClass(editPriority)} />
                <Input
                  value={editTitle}
                  onChange={(e) => setEditTitle(e.target.value)}
                  className="font-medium input-warm"
                  onKeyDown={(e) => {
                    if (e.key === 'Enter') handleSaveEdit();
                    if (e.key === 'Escape') handleCancelEdit();
                  }}
                  autoFocus
                />
              </div>

              {/* Edit Priority & Due Date */}
              <div className="flex items-center gap-2 ml-6">
                <Select value={editPriority} onValueChange={(value: 'low' | 'medium' | 'high') => setEditPriority(value)}>
                  <SelectTrigger className="w-24 h-8">
                    <SelectValue />
                  </SelectTrigger>
                  <SelectContent>
                    <SelectItem value="low">
                      <div className="flex items-center gap-2">
                        <div className="priority-dot-low" />
                        <span>Low</span>
                      </div>
                    </SelectItem>
                    <SelectItem value="medium">
                      <div className="flex items-center gap-2">
                        <div className="priority-dot-medium" />
                        <span>Medium</span>
                      </div>
                    </SelectItem>
                    <SelectItem value="high">
                      <div className="flex items-center gap-2">
                        <div className="priority-dot-high" />
                        <span>High</span>
                      </div>
                    </SelectItem>
                  </SelectContent>
                </Select>

                <Popover open={isCalendarOpen} onOpenChange={setIsCalendarOpen}>
                  <PopoverTrigger asChild>
                    <Button variant="outline" size="sm" className="h-8 text-xs">
                      <Calendar className="w-3 h-3 mr-1" />
                      {editDueDate ? format(editDueDate, 'MMM d') : 'Due date'}
                    </Button>
                  </PopoverTrigger>
                  <PopoverContent className="w-auto p-0" align="start">
                    <CalendarComponent
                      mode="single"
                      selected={editDueDate}
                      onSelect={setEditDueDate}
                      disabled={(date) => date < new Date(new Date().setHours(0, 0, 0, 0))}
                      initialFocus
                    />
                  </PopoverContent>
                </Popover>

                {editDueDate && (
                  <Button
                    variant="ghost"
                    size="sm"
                    className="h-8 w-8 p-0 hover:bg-destructive/10 hover:text-destructive"
                    onClick={() => setEditDueDate(undefined)}
                  >
                    <X className="w-3 h-3" />
                  </Button>
                )}
              </div>

              {/* Save/Cancel Buttons */}
              <div className="flex items-center gap-2 ml-6">
                <Button size="sm" className="h-8 btn-primary" onClick={handleSaveEdit}>
                  <Check className="w-3 h-3 mr-1" />
                  Save
                </Button>
                <Button variant="outline" size="sm" className="h-8" onClick={handleCancelEdit}>
                  <X className="w-3 h-3 mr-1" />
                  Cancel
                </Button>
              </div>
            </div>
          ) : (
            <div>
              <div className="flex items-center gap-2 mb-2">
                <div className={getPriorityDotClass(task.priority)} />
                <h3 className={cn(
                  'font-medium text-foreground transition-all duration-200',
                  task.completed && 'line-through opacity-60'
                )}>
                  {task.title}
                </h3>
                {task.dueDate && (
                  <Badge variant="outline" className="text-xs flex items-center gap-1">
                    <Calendar className="w-3 h-3" />
                    {format(task.dueDate, 'MMM d')}
                  </Badge>
                )}
              </div>
            </div>
          )}

          {/* Subtasks Section - Always show Add Subtask button */}
          <div className="mt-3">
            {totalSubtasks > 0 && (
              <div className="flex items-center gap-2 mb-2">
                <Button
                  variant="ghost"
                  size="sm"
                  className="h-6 w-6 p-0 hover:bg-accent"
                  onClick={() => setIsExpanded(!isExpanded)}
                >
                  {isExpanded ? (
                    <ChevronDown className="w-3 h-3" />
                  ) : (
                    <ChevronRight className="w-3 h-3" />
                  )}
                </Button>
                <span className="text-xs text-muted-foreground">
                  {completedSubtasks}/{totalSubtasks} subtasks
                </span>
              </div>
            )}

            {(isExpanded || totalSubtasks === 0) && (
              <div className="ml-4 space-y-2">
                {task.subtasks.map(subtask => (
                  <div key={subtask.id} className="flex items-center gap-2 group">
                    <Checkbox
                      checked={subtask.completed}
                      onCheckedChange={() => handleSubtaskToggle(subtask.id)}
                      className="w-4 h-4"
                    />
                    <span className={cn(
                      'text-sm flex-1',
                      subtask.completed && 'line-through opacity-60'
                    )}>
                      {subtask.title}
                    </span>
                    <Button
                      variant="ghost"
                      size="sm"
                      className="h-6 w-6 p-0 opacity-0 group-hover:opacity-100 transition-opacity hover:bg-destructive/10 hover:text-destructive"
                      onClick={() => handleDeleteSubtask(subtask.id)}
                    >
                      <Trash2 className="w-3 h-3" />
                    </Button>
                  </div>
                ))}

                {isAddingSubtask ? (
                  <div className="flex items-center gap-2">
                    <div className="w-4 h-4" />
                    <Input
                      value={newSubtaskTitle}
                      onChange={(e) => setNewSubtaskTitle(e.target.value)}
                      placeholder="Add subtask..."
                      className="h-8 text-sm input-warm"
                      onKeyDown={(e) => {
                        if (e.key === 'Enter') handleAddSubtask();
                        if (e.key === 'Escape') {
                          setIsAddingSubtask(false);
                          setNewSubtaskTitle('');
                        }
                      }}
                      autoFocus
                    />
                    <Button
                      size="sm"
                      className="h-8 btn-primary"
                      onClick={handleAddSubtask}
                    >
                      Add
                    </Button>
                  </div>
                ) : (
                  <Button
                    variant="ghost"
                    size="sm"
                    className="h-8 w-full justify-start text-muted-foreground hover:text-foreground hover:bg-accent"
                    onClick={() => setIsAddingSubtask(true)}
                  >
                    <Plus className="w-3 h-3 mr-2" />
                    Add subtask
                  </Button>
                )}
              </div>
            )}
          </div>
        </div>

        {/* Task Actions */}
        <div className="flex items-center gap-1">
          <Button
            variant="ghost"
            size="sm"
            className="h-8 w-8 p-0 opacity-0 group-hover:opacity-100 transition-opacity hover:bg-accent"
            onClick={handleStartEdit}
          >
            <Edit2 className="w-4 h-4" />
          </Button>
          <Button
            variant="ghost"
            size="sm"
            className="h-8 w-8 p-0 opacity-0 group-hover:opacity-100 transition-opacity hover:bg-destructive/10 hover:text-destructive"
            onClick={() => onDelete(task.id)}
          >
            <Trash2 className="w-4 h-4" />
          </Button>
        </div>
      </div>
    </div>
  );
};
