<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Xee Pro - Task Management</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    :root {
      --primary: #6c5ce7;
      --primary-dark: #5649c5;
      --secondary: #a29bfe;
      --accent: #fd79a8;
      --light: #f8f9fa;
      --dark: #2d3436;
      --success: #00b894;
      --warning: #fdcb6e;
      --danger: #d63031;
      --gray: #dfe6e9;
      --dark-gray: #636e72;
      --card-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
      --transition: all 0.3s ease;
      --bg-color: white;
      --text-color: #2d3436;
      --card-bg: white;
      --input-bg: white;
      --border-color: #dfe6e9;
    }

    [data-theme="dark"] {
      --bg-color: #1a1c23;
      --text-color: #f8f9fa;
      --card-bg: #2d3038;
      --input-bg: #3a3d46;
      --border-color: #444752;
      --gray: #444752;
      --dark-gray: #a0a5b1;
      --card-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
      min-height: 100vh;
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 20px;
      color: var(--text-color);
      background-color: var(--bg-color);
      transition: var(--transition);
    }

    [data-theme="dark"] body {
      background: linear-gradient(135deg, #1a1c23 0%, #2d3038 100%);
    }

    .container {
      background: var(--card-bg);
      padding: 30px;
      border-radius: 20px;
      box-shadow: var(--card-shadow);
      width: 100%;
      max-width: 1100px;
      transition: var(--transition);
    }

    .app-header {
      text-align: center;
      margin-bottom: 25px;
      position: relative;
    }

    .app-header h1 {
      color: var(--primary);
      font-size: 32px;
      margin-bottom: 5px;
      font-weight: 700;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
    }

    .app-header p {
      color: var(--text-color);
      opacity: 0.7;
      font-size: 14px;
    }

    .auth-section, .todo-section {
      transition: var(--transition);
    }

    .dashboard {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 15px;
      margin-bottom: 30px;
    }

    .stat-card {
      background: var(--card-bg);
      padding: 20px;
      border-radius: 12px;
      box-shadow: var(--card-shadow);
      text-align: center;
    }

    .stat-value {
      font-size: 28px;
      font-weight: 700;
      color: var(--primary);
      margin-bottom: 5px;
    }

    .stat-label {
      font-size: 14px;
      color: var(--dark-gray);
    }

    .productivity-card {
      background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
      color: white;
    }

    .productivity-card .stat-value,
    .productivity-card .stat-label {
      color: white;
    }

    .divider {
      height: 1px;
      background: var(--gray);
      margin: 25px 0;
    }

    .section-title {
      font-size: 20px;
      font-weight: 600;
      margin-bottom: 20px;
      color: var(--text-color);
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .section-title i {
      color: var(--primary);
    }

    .task-form {
      display: grid;
      grid-template-columns: 2fr 1fr 1fr;
      gap: 15px;
      margin-bottom: 25px;
    }

    .input-group {
      position: relative;
    }

    .input-group i {
      position: absolute;
      left: 15px;
      top: 50%;
      transform: translateY(-50%);
      color: var(--secondary);
      z-index: 1;
    }

    input[type="email"], input[type="password"], input[type="text"], 
    input[type="date"], select, textarea {
      width: 100%;
      padding: 15px 15px 15px 45px;
      border: 2px solid var(--border-color);
      border-radius: 10px;
      font-size: 16px;
      transition: var(--transition);
      background-color: var(--input-bg);
      color: var(--text-color);
    }

    textarea {
      min-height: 100px;
      resize: vertical;
    }

    input:focus, select:focus, textarea:focus {
      border-color: var(--primary);
      outline: none;
      box-shadow: 0 0 0 3px rgba(108, 92, 231, 0.2);
    }

    .btn-group {
      display: flex;
      gap: 10px;
      margin-top: 20px;
    }

    button {
      padding: 12px 20px;
      border: none;
      border-radius: 10px;
      cursor: pointer;
      font-size: 16px;
      font-weight: 600;
      transition: var(--transition);
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }

    .btn-primary {
      background-color: var(--primary);
      color: white;
      flex: 1;
    }

    .btn-primary:hover {
      background-color: var(--primary-dark);
      transform: translateY(-2px);
    }

    .btn-secondary {
      background-color: var(--secondary);
      color: white;
      flex: 1;
    }

    .btn-secondary:hover {
      background-color: #9186fd;
      transform: translateY(-2px);
    }

    .btn-danger {
      background-color: var(--danger);
      color: white;
    }

    .btn-danger:hover {
      background-color: #c02b2b;
      transform: translateY(-2px);
    }

    .btn-success {
      background-color: var(--success);
      color: white;
    }

    .btn-success:hover {
      background-color: #00a382;
      transform: translateY(-2px);
    }

    .btn-accent {
      background-color: var(--accent);
      color: white;
      padding: 10px 15px;
    }

    .btn-accent:hover {
      background-color: #fc6ba7;
      transform: translateY(-2px);
    }

    .btn-warning {
      background-color: var(--warning);
      color: var(--dark);
    }

    .btn-warning:hover {
      background-color: #f5b84d;
      transform: translateY(-2px);
    }

    .error {
      color: var(--danger);
      font-size: 14px;
      margin: 10px 0;
      text-align: center;
      min-height: 20px;
    }

    .success {
      color: var(--success);
      font-size: 14px;
      margin: 10px 0;
      text-align: center;
      min-height: 20px;
    }

    .task-filters {
      display: flex;
      gap: 10px;
      margin-bottom: 15px;
      flex-wrap: wrap;
    }

    .filter-btn {
      background: none;
      border: 2px solid var(--border-color);
      color: var(--text-color);
      padding: 8px 15px;
      font-size: 14px;
      border-radius: 20px;
    }

    .filter-btn.active {
      background-color: var(--primary);
      color: white;
      border-color: var(--primary);
    }

    ul {
      list-style: none;
      margin: 20px 0;
      max-height: 350px;
      overflow-y: auto;
      padding-right: 5px;
    }

    li {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 15px;
      margin-bottom: 10px;
      border-radius: 10px;
      background-color: var(--card-bg);
      transition: var(--transition);
      animation: fadeIn 0.5s ease;
      cursor: grab;
      border-left: 4px solid;
    }

    li:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
    }

    li.dragging {
      opacity: 0.5;
      background-color: var(--secondary);
    }

    li.completed {
      background-color: rgba(0, 184, 148, 0.1);
    }

    li.completed .task-text {
      text-decoration: line-through;
      color: #777;
    }

    .task-text {
      flex: 1;
      padding: 0 15px;
      word-break: break-word;
    }

    .task-details {
      display: flex;
      flex-direction: column;
      gap: 5px;
      font-size: 12px;
      color: var(--dark-gray);
    }

    .task-priority {
      display: inline-block;
      padding: 3px 8px;
      border-radius: 20px;
      font-size: 11px;
      font-weight: bold;
    }

    .priority-high {
      background-color: rgba(214, 48, 49, 0.1);
      color: var(--danger);
    }

    .priority-medium {
      background-color: rgba(253, 203, 110, 0.1);
      color: var(--warning);
    }

    .priority-low {
      background-color: rgba(0, 184, 148, 0.1);
      color: var(--success);
    }

    .task-actions {
      display: flex;
      gap: 5px;
    }

    .empty-state {
      text-align: center;
      padding: 30px;
      color: #999;
    }

    .empty-state i {
      font-size: 50px;
      margin-bottom: 15px;
      color: var(--secondary);
    }

    .user-info {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 20px;
      padding-bottom: 15px;
      border-bottom: 1px solid var(--border-color);
    }

    .user-email {
      font-weight: 500;
      color: var(--primary);
      overflow: hidden;
      text-overflow: ellipsis;
      max-width: 200px;
    }

    .theme-toggle {
      background: none;
      border: none;
      font-size: 24px;
      cursor: pointer;
      color: var(--text-color);
      margin-left: 15px;
    }

    .search-container {
      position: relative;
      margin-bottom: 20px;
    }

    .search-container i {
      position: absolute;
      left: 15px;
      top: 50%;
      transform: translateY(-50%);
      color: var(--secondary);
    }

    .search-container input {
      padding-left: 45px;
    }

    .calendar-view {
      margin-top: 20px;
    }

    .calendar-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
    }

    .calendar-grid {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 5px;
    }

    .calendar-day {
      padding: 10px;
      border-radius: 8px;
      text-align: center;
      background-color: var(--card-bg);
      min-height: 80px;
      cursor: pointer;
      transition: var(--transition);
    }

    .calendar-day:hover {
      background-color: var(--secondary);
      color: white;
    }

    .calendar-day.active {
      background-color: var(--primary);
      color: white;
    }

    .calendar-day.has-tasks {
      border-bottom: 3px solid var(--accent);
    }

    .day-header {
      font-weight: bold;
      margin-bottom: 5px;
    }

    .task-count {
      font-size: 12px;
      background-color: var(--accent);
      color: white;
      border-radius: 50%;
      width: 20px;
      height: 20px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
    }

    .task-detail-modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.5);
      z-index: 1000;
      justify-content: center;
      align-items: center;
    }

    .modal-content {
      background-color: var(--card-bg);
      padding: 30px;
      border-radius: 15px;
      width: 90%;
      max-width: 500px;
      box-shadow: var(--card-shadow);
    }

    .close-modal {
      float: right;
      font-size: 24px;
      cursor: pointer;
    }

    .file-upload {
      margin-top: 15px;
    }

    .file-preview {
      margin-top: 10px;
      max-width: 100%;
      max-height: 200px;
    }

    .attachment-item {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-top: 10px;
      padding: 5px;
      background-color: var(--input-bg);
      border-radius: 5px;
    }

    .due-date-proximity-urgent {
      border-left-color: var(--danger) !important;
    }

    .due-date-proximity-soon {
      border-left-color: var(--warning) !important;
    }

    .due-date-proximity-future {
      border-left-color: var(--success) !important;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    /* Scrollbar styling */
    ::-webkit-scrollbar {
      width: 8px;
    }

    ::-webkit-scrollbar-track {
      background: #f1f1f1;
      border-radius: 10px;
    }

    ::-webkit-scrollbar-thumb {
      background: var(--secondary);
      border-radius: 10px;
    }

    ::-webkit-scrollbar-thumb:hover {
      background: var(--primary);
    }

    [data-theme="dark"] ::-webkit-scrollbar-track {
      background: #2d3038;
    }

    /* Loading spinner */
    .spinner {
      border: 4px solid rgba(0, 0, 0, 0.1);
      border-radius: 50%;
      border-top: 4px solid var(--primary);
      width: 30px;
      height: 30px;
      animation: spin 1s linear infinite;
      margin: 20px auto;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    /* Mobile-specific styles */
    @media (max-width: 768px) {
      body {
        padding: 10px;
        align-items: flex-start;
        min-height: 100vh;
        height: auto;
      }
      
      .container {
        padding: 20px;
        border-radius: 15px;
        margin: 10px 0;
      }
      
      .dashboard {
        grid-template-columns: repeat(2, 1fr);
      }
      
      .app-header h1 {
        font-size: 28px;
      }
      
      .task-form {
        grid-template-columns: 1fr;
      }
      
      .btn-group {
        flex-direction: column;
      }
      
      .task-filters {
        justify-content: center;
      }
      
      .user-info {
        flex-direction: column;
        align-items: flex-start;
        gap: 10px;
      }
      
      .user-email {
        max-width: 100%;
      }
      
      li {
        flex-direction: column;
        align-items: flex-start;
        gap: 10px;
      }
      
      .task-actions {
        align-self: flex-end;
      }
      
      input[type="email"], input[type="password"], input[type="text"], 
      input[type="date"], select {
        font-size: 16px;
      }

      .calendar-grid {
        grid-template-columns: repeat(7, 1fr);
        overflow-x: auto;
      }

      .calendar-day {
        min-width: 40px;
        min-height: 60px;
        font-size: 12px;
      }
    }

    /* Animation for task completion */
    @keyframes taskComplete {
      0% { transform: scale(1); }
      50% { transform: scale(1.05); }
      100% { transform: scale(1); }
    }

    .task-complete-animation {
      animation: taskComplete 0.5s ease;
    }

    /* New styles for additional features */
    .category-tag {
      display: inline-block;
      padding: 3px 8px;
      border-radius: 12px;
      font-size: 11px;
      font-weight: bold;
      margin-right: 5px;
      background-color: var(--secondary);
      color: white;
    }

    .recurring-badge {
      display: inline-block;
      padding: 3px 8px;
      border-radius: 12px;
      font-size: 11px;
      font-weight: bold;
      margin-right: 5px;
      background-color: var(--accent);
      color: white;
    }

    .collaborator-avatar {
      width: 24px;
      height: 24px;
      border-radius: 50%;
      background-color: var(--primary);
      color: white;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      font-size: 12px;
      margin-right: 5px;
    }

    .export-options {
      display: flex;
      gap: 10px;
      margin-top: 20px;
    }

    .notification-badge {
      position: absolute;
      top: -5px;
      right: -5px;
      background-color: var(--danger);
      color: white;
      border-radius: 50%;
      width: 18px;
      height: 18px;
      font-size: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .notifications-container {
      position: relative;
    }

    .notification-dropdown {
      display: none;
      position: absolute;
      top: 40px;
      right: 0;
      width: 300px;
      background-color: var(--card-bg);
      border-radius: 10px;
      box-shadow: var(--card-shadow);
      z-index: 100;
      padding: 15px;
      max-height: 300px;
      overflow-y: auto;
    }

    .notification-item {
      padding: 10px;
      border-bottom: 1px solid var(--border-color);
    }

    .notification-item:last-child {
      border-bottom: none;
    }

    .settings-panel {
      display: none;
      margin-top: 20px;
      padding: 20px;
      background-color: var(--card-bg);
      border-radius: 10px;
      box-shadow: var(--card-shadow);
    }

    .recurring-options {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
      margin-top: 10px;
    }

    .category-selector {
      display: flex;
      flex-wrap: wrap;
      gap: 5px;
      margin-top: 10px;
    }

    .category-option {
      padding: 5px 10px;
      border-radius: 15px;
      background-color: var(--input-bg);
      cursor: pointer;
      font-size: 14px;
    }

    .category-option.selected {
      background-color: var(--primary);
      color: white;
    }

    .collaborator-input {
      display: flex;
      gap: 10px;
      margin-top: 10px;
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- Auth Section -->
    <div class="auth-section" id="authSection">
      <div class="app-header">
        <h1><i class="fas fa-tasks"></i> Xee Pro</h1>
        <p>Professional Task Management</p>
      </div>
      
      <div class="input-group">
        <i class="fas fa-envelope"></i>
        <input type="email" id="email" placeholder="Enter your email" />
      </div>
      
      <div class="input-group">
        <i class="fas fa-lock"></i>
        <input type="password" id="password" placeholder="Enter your password" />
      </div>

      <div class="input-group">
        <i class="fas fa-lock"></i>
        <input type="password" id="confirmPassword" placeholder="Confirm your password" />
      </div>
      
      <div class="btn-group">
        <button class="btn-primary" onclick="signUp()">
          <i class="fas fa-user-plus"></i> Sign Up
        </button>
        <button class="btn-secondary" onclick="signIn()">
          <i class="fas fa-sign-in-alt"></i> Sign In
        </button>
      </div>

      <div style="text-align: center; margin-top: 15px;">
        <a href="#" onclick="showPasswordReset()" style="color: var(--primary); text-decoration: none;">
          Forgot your password?
        </a>
      </div>
      
      <p class="error" id="error"></p>
      <p class="success" id="success"></p>
    </div>

    <!-- Password Reset Section -->
    <div class="auth-section" id="passwordResetSection" style="display: none;">
      <div class="app-header">
        <h1><i class="fas fa-key"></i> Reset Password</h1>
        <p>Enter your email to reset your password</p>
      </div>
      
      <div class="input-group">
        <i class="fas fa-envelope"></i>
        <input type="email" id="resetEmail" placeholder="Enter your email" />
      </div>
      
      <div class="btn-group">
        <button class="btn-primary" onclick="sendPasswordReset()">
          <i class="fas fa-paper-plane"></i> Send Reset Link
        </button>
        <button class="btn-secondary" onclick="showAuthSection()">
          <i class="fas fa-arrow-left"></i> Back to Login
        </button>
      </div>
      
      <p class="error" id="resetError"></p>
      <p class="success" id="resetSuccess"></p>
    </div>

    <!-- To-Do Section -->
    <div class="todo-section" id="todoSection" style="display: none;">
      <div class="user-info">
        <div>
          <h2>Xee Pro Dashboard</h2>
          <span class="user-email" id="userEmail"></span>
        </div>
        <div style="display: flex; align-items: center; gap: 10px;">
          <div class="notifications-container">
            <button class="theme-toggle" onclick="toggleNotifications()" title="Notifications">
              <i class="fas fa-bell"></i>
              <span class="notification-badge" id="notificationBadge" style="display: none;">0</span>
            </button>
            <div class="notification-dropdown" id="notificationDropdown">
              <h4>Notifications</h4>
              <div id="notificationList"></div>
            </div>
          </div>
          <button class="theme-toggle" id="themeToggle">
            <i class="fas fa-moon"></i>
          </button>
          <button class="btn-accent" onclick="showSettings()" title="Settings">
            <i class="fas fa-cog"></i>
          </button>
          <button class="btn-danger" onclick="signOut()" title="Sign Out">
            <i class="fas fa-sign-out-alt"></i>
          </button>
        </div>
      </div>

      <!-- Settings Panel -->
      <div class="settings-panel" id="settingsPanel">
        <h3>Settings</h3>
        <div class="divider"></div>
        
        <h4>Export Data</h4>
        <div class="export-options">
          <button class="btn-warning" onclick="exportData('json')">
            <i class="fas fa-file-code"></i> Export as JSON
          </button>
          <button class="btn-warning" onclick="exportData('csv')">
            <i class="fas fa-file-csv"></i> Export as CSV
          </button>
        </div>
        
        <div class="divider"></div>
        
        <h4>Notification Preferences</h4>
        <div class="input-group">
          <label>
            <input type="checkbox" id="emailNotifications" checked />
            Email notifications for due tasks
          </label>
        </div>
        
        <div class="input-group">
          <label>
            <input type="number" id="reminderTime" value="1" min="1" max="24" />
            Hours before due date to remind me
          </label>
        </div>
        
        <button class="btn-success" onclick="saveSettings()">
          <i class="fas fa-save"></i> Save Settings
        </button>
      </div>
      
      <!-- Search Bar -->
      <div class="search-container">
        <i class="fas fa-search"></i>
        <input type="text" id="searchInput" placeholder="Search tasks..." oninput="searchTasks()" />
      </div>
      
      <!-- Stats Dashboard -->
      <div class="dashboard">
        <div class="stat-card">
          <div class="stat-value" id="totalTasks">0</div>
          <div class="stat-label">Total Tasks</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="completedTasks">0</div>
          <div class="stat-label">Completed</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="overdueTasks">0</div>
          <div class="stat-label">Overdue</div>
        </div>
        <div class="stat-card productivity-card">
          <div class="stat-value" id="productivityRate">0%</div>
          <div class="stat-label">Productivity</div>
        </div>
      </div>

      <div class="divider"></div>
      
      <!-- Calendar View Button -->
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
        <div class="section-title">
          <i class="fas fa-plus-circle"></i> Add New Task
        </div>
        <button class="btn-accent" onclick="toggleCalendarView()">
          <i class="fas fa-calendar"></i> Calendar View
        </button>
      </div>
      
      <div class="task-form">
        <div class="input-group">
          <i class="fas fa-tasks"></i>
          <input type="text" id="taskInput" placeholder="What needs to be done?" />
        </div>
        
        <div class="input-group">
          <i class="fas fa-calendar-day"></i>
          <input type="date" id="dueDateInput" />
        </div>
        
        <div class="input-group">
          <i class="fas fa-flag"></i>
          <select id="priorityInput">
            <option value="low">Low Priority</option>
            <option value="medium" selected>Medium Priority</option>
            <option value="high">High Priority</option>
          </select>
        </div>
      </div>

      <div class="input-group">
        <i class="fas fa-align-left"></i>
        <textarea id="taskDescription" placeholder="Task description (optional)"></textarea>
      </div>

      <!-- Category Selection -->
      <div class="input-group">
        <i class="fas fa-tag"></i>
        <div style="padding-left: 45px;">
          <label>Category:</label>
          <div class="category-selector" id="categorySelector">
            <div class="category-option" data-category="work">Work</div>
            <div class="category-option" data-category="personal">Personal</div>
            <div class="category-option" data-category="shopping">Shopping</div>
            <div class="category-option" data-category="health">Health</div>
            <div class="category-option" data-category="other">Other</div>
          </div>
        </div>
      </div>

      <!-- Recurring Task Options -->
      <div class="input-group">
        <i class="fas fa-repeat"></i>
        <div style="padding-left: 45px;">
          <label>
            <input type="checkbox" id="recurringTask" onchange="toggleRecurringOptions()" />
            Recurring Task
          </label>
          <div class="recurring-options" id="recurringOptions" style="display: none;">
            <select id="recurringFrequency">
              <option value="daily">Daily</option>
              <option value="weekly">Weekly</option>
              <option value="monthly">Monthly</option>
            </select>
            <input type="number" id="recurringInterval" value="1" min="1" max="30" placeholder="Interval" />
          </div>
        </div>
      </div>

      <!-- Collaborators -->
      <div class="input-group">
        <i class="fas fa-users"></i>
        <div style="padding-left: 45px;">
          <label>Collaborators:</label>
          <div class="collaborator-input">
            <input type="email" id="collaboratorEmail" placeholder="Enter collaborator's email" />
            <button class="btn-warning" onclick="addCollaborator()">
              <i class="fas fa-plus"></i> Add
            </button>
          </div>
          <div id="collaboratorsList"></div>
        </div>
      </div>

      <div class="file-upload">
        <label for="fileInput" class="btn-warning">
          <i class="fas fa-paperclip"></i> Attach File
        </label>
        <input type="file" id="fileInput" style="display: none;" onchange="previewFile()" />
        <div id="filePreview" class="file-preview"></div>
      </div>
      
      <button class="btn-accent" onclick="addTask()">
        <i class="fas fa-plus-circle"></i> Add Task
      </button>
      
      <p class="error" id="taskError"></p>
      <p class="success" id="taskSuccess"></p>

      <div class="divider"></div>
      
      <!-- Calendar View -->
      <div class="calendar-view" id="calendarView" style="display: none;">
        <div class="calendar-header">
          <button class="btn-warning" onclick="prevMonth()">
            <i class="fas fa-chevron-left"></i>
          </button>
          <h3 id="calendarMonth">September 2023</h3>
          <button class="btn-warning" onclick="nextMonth()">
            <i class="fas fa-chevron-right"></i>
          </button>
        </div>
        <div class="calendar-grid" id="calendarGrid">
          <!-- Calendar will be generated here -->
        </div>
        <div class="divider"></div>
      </div>
      
      <!-- Task List Section -->
      <div class="section-title">
        <i class="fas fa-list-check"></i> My Tasks
      </div>
      
      <div class="task-filters">
        <button class="filter-btn active" onclick="changeFilter('all')">All</button>
        <button class="filter-btn" onclick="changeFilter('active')">Active</button>
        <button class="filter-btn" onclick="changeFilter('completed')">Completed</button>
        <button class="filter-btn" onclick="changeFilter('high')">High Priority</button>
        <button class="filter-btn" onclick="changeFilter('overdue')">Overdue</button>
      </div>
      
      <ul id="taskList"></ul>

      <div id="loadingSpinner" class="spinner" style="display: none;"></div>
    </div>
  </div>

  <!-- Task Detail Modal -->
  <div class="task-detail-modal" id="taskDetailModal">
    <div class="modal-content">
      <span class="close-modal" onclick="closeModal()">&times;</span>
      <h3>Task Details</h3>
      <div id="modalTaskContent"></div>
    </div>
  </div>

  <!-- Firebase SDK (Modular) -->
  <script type="module">
    // Import Firebase SDK modules
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js';
    import { 
      getAuth, 
      createUserWithEmailAndPassword, 
      signInWithEmailAndPassword, 
      signOut, 
      onAuthStateChanged,
      setPersistence,
      browserLocalPersistence,
      sendPasswordResetEmail
    } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js';
    import { getDatabase, ref, push, set, onValue, update, remove, serverTimestamp } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js';
    import { getStorage, ref as storageRef, uploadBytes, getDownloadURL, deleteObject } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-storage.js';

    // Firebase configuration
    const firebaseConfig = {
      apiKey: "AIzaSyDe8yzLDj8Y-gzHqS2arkwbD989LwIO4DQ",
      authDomain: "todoapp-5d6ec.firebaseapp.com",
      databaseURL: "https://todoapp-5d6ec-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "todoapp-5d6ec",
      storageBucket: "todoapp-5d6ec.firebasestorage.app",
      messagingSenderId: "720430702785",
      appId: "1:720430702785:web:af612a4935cdc731ccb440",
      measurementId: "G-YG48X4LZ97"
    };

    // Initialize Firebase
    try {
      const app = initializeApp(firebaseConfig);
      const auth = getAuth(app);
      const database = getDatabase(app);
      const storage = getStorage(app);
      console.log('Firebase initialized successfully');

      // Set authentication persistence
      setPersistence(auth, browserLocalPersistence)
        .then(() => {
          console.log("Auth persistence set to LOCAL (user stays logged in between sessions)");
        })
        .catch((error) => {
          console.error("Error setting auth persistence:", error);
        });

      let currentFilter = 'all';
      let allTasks = [];
      let currentDraggedTask = null;
      let currentMonth = new Date().getMonth();
      let currentYear = new Date().getFullYear();
      let currentView = 'list'; // 'list' or 'calendar'
      let currentEditingTaskId = null;
      let attachedFile = null;
      let selectedCategory = 'work';
      let collaborators = [];
      let notifications = [];
      let userSettings = {};

      // Check authentication state on page load
      onAuthStateChanged(auth, (user) => {
        console.log('Auth state changed, user:', user ? user.uid : 'No user');
        if (user) {
          // User is signed in
          showTodoSection();
          const userId = user.uid;
          document.getElementById('userEmail').textContent = user.email;
          
          // Load user settings
          loadUserSettings(userId);
          
          // Load tasks
          const tasksRef = ref(database, `tasks/${userId}`);
          
          // Show loading spinner
          document.getElementById('loadingSpinner').style.display = 'block';
          
          onValue(tasksRef, snapshot => {
            allTasks = [];
            if (snapshot.exists()) {
              snapshot.forEach(child => {
                allTasks.push({
                  id: child.key,
                  ...child.val()
                });
              });
            }
            renderTasks(allTasks);
            updateTaskStats(allTasks);
            if (currentView === 'calendar') {
              renderCalendar();
            }
            
            // Hide loading spinner
            document.getElementById('loadingSpinner').style.display = 'none';
            
            // Check for notifications
            checkNotifications(allTasks);
          }, error => {
            document.getElementById('taskError').innerText = error.message;
            console.error('Error fetching tasks:', error);
            document.getElementById('loadingSpinner').style.display = 'none';
          });
        } else {
          // User is signed out
          document.getElementById('authSection').style.display = 'block';
          document.getElementById('todoSection').style.display = 'none';
          document.getElementById('passwordResetSection').style.display = 'none';
          document.getElementById('taskList').innerHTML = '';
          document.getElementById('taskError').innerText = '';
        }
      });

      // Dark Mode Toggle
      const themeToggle = document.getElementById('themeToggle');
      themeToggle.addEventListener('click', () => {
        const body = document.body;
        if (body.getAttribute('data-theme') === 'dark') {
          body.removeAttribute('data-theme');
          themeToggle.innerHTML = '<i class="fas fa-moon"></i>';
          localStorage.setItem('theme', 'light');
        } else {
          body.setAttribute('data-theme', 'dark');
          themeToggle.innerHTML = '<i class="fas fa-sun"></i>';
          localStorage.setItem('theme', 'dark');
        }
      });

      // Check for saved theme preference
      if (localStorage.getItem('theme') === 'dark') {
        document.body.setAttribute('data-theme', 'dark');
        themeToggle.innerHTML = '<i class="fas fa-sun"></i>';
      }

      // Authentication functions
      window.signUp = async function() {
        const email = document.getElementById('email').value.trim();
        const password = document.getElementById('password').value;
        const confirmPassword = document.getElementById('confirmPassword').value;
        const errorDisplay = document.getElementById('error');
        const successDisplay = document.getElementById('success');
        
        errorDisplay.innerText = '';
        successDisplay.innerText = '';
        
        if (!email || !password || !confirmPassword) {
          errorDisplay.innerText = 'Please fill in all fields.';
          console.error('Sign-up: Missing fields');
          return;
        }
        
        if (password !== confirmPassword) {
          errorDisplay.innerText = 'Passwords do not match.';
          console.error('Sign-up: Passwords do not match');
          return;
        }
        
        if (password.length < 6) {
          errorDisplay.innerText = 'Password should be at least 6 characters.';
          console.error('Sign-up: Password too short');
          return;
        }
        
        try {
          await createUserWithEmailAndPassword(auth, email, password);
          successDisplay.innerText = 'Account created successfully!';
          console.log('Sign-up successful, email:', email);
          
          // Clear form
          document.getElementById('email').value = '';
          document.getElementById('password').value = '';
          document.getElementById('confirmPassword').value = '';
        } catch (error) {
          errorDisplay.innerText = error.message;
          console.error('Sign-up error:', error);
        }
      };

      window.signIn = async function() {
        const email = document.getElementById('email').value.trim();
        const password = document.getElementById('password').value;
        const errorDisplay = document.getElementById('error');
        
        errorDisplay.innerText = '';
        if (!email || !password) {
          errorDisplay.innerText = 'Please enter both email and password.';
          console.error('Sign-in: Missing email or password');
          return;
        }
        
        // Show loading state
        const signInBtn = event.target;
        const originalText = signInBtn.innerHTML;
        signInBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Signing In...';
        signInBtn.disabled = true;
        
        try {
          await signInWithEmailAndPassword(auth, email, password);
          console.log('Sign-in successful, email:', email);
        } catch (error) {
          errorDisplay.innerText = error.message;
          console.error('Sign-in error:', error);
          
          // Reset button
          signInBtn.innerHTML = originalText;
          signInBtn.disabled = false;
        }
      };

      window.signOut = async function() {
        try {
          await signOut(auth);
          document.getElementById('authSection').style.display = 'block';
          document.getElementById('todoSection').style.display = 'none';
          document.getElementById('email').value = '';
          document.getElementById('password').value = '';
          document.getElementById('confirmPassword').value = '';
          document.getElementById('taskError').innerText = '';
          document.getElementById('error').innerText = '';
          console.log('Sign-out successful');
        } catch (error) {
          document.getElementById('error').innerText = error.message;
          console.error('Sign-out error:', error);
        }
      };

      // Password reset functions
      window.showPasswordReset = function() {
        document.getElementById('authSection').style.display = 'none';
        document.getElementById('passwordResetSection').style.display = 'block';
      };

      window.showAuthSection = function() {
        document.getElementById('authSection').style.display = 'block';
        document.getElementById('passwordResetSection').style.display = 'none';
      };

      window.sendPasswordReset = async function() {
        const email = document.getElementById('resetEmail').value.trim();
        const errorDisplay = document.getElementById('resetError');
        const successDisplay = document.getElementById('resetSuccess');
        
        errorDisplay.innerText = '';
        successDisplay.innerText = '';
        
        if (!email) {
          errorDisplay.innerText = 'Please enter your email address.';
          return;
        }
        
        try {
          await sendPasswordResetEmail(auth, email);
          successDisplay.innerText = 'Password reset email sent! Check your inbox.';
          console.log('Password reset email sent to:', email);
        } catch (error) {
          errorDisplay.innerText = error.message;
          console.error('Password reset error:', error);
        }
      };

      // Show to-do section
      function showTodoSection() {
        document.getElementById('authSection').style.display = 'none';
        document.getElementById('passwordResetSection').style.display = 'none';
        document.getElementById('todoSection').style.display = 'block';
        document.getElementById('error').innerText = '';
        document.getElementById('taskError').innerText = '';
        document.getElementById('userEmail').textContent = auth.currentUser.email;
        
        // Set today's date as default for due date
        const today = new Date().toISOString().split('T')[0];
        document.getElementById('dueDateInput').value = today;
        
        // Initialize category selection
        initCategorySelection();
      }

      // Initialize category selection
      function initCategorySelection() {
        const categoryOptions = document.querySelectorAll('.category-option');
        categoryOptions.forEach(option => {
          option.addEventListener('click', () => {
            categoryOptions.forEach(opt => opt.classList.remove('selected'));
            option.classList.add('selected');
            selectedCategory = option.getAttribute('data-category');
          });
        });
        
        // Select first category by default
        if (categoryOptions.length > 0) {
          categoryOptions[0].classList.add('selected');
        }
      }

      // Toggle recurring options
      window.toggleRecurringOptions = function() {
        const recurringCheckbox = document.getElementById('recurringTask');
        const recurringOptions = document.getElementById('recurringOptions');
        recurringOptions.style.display = recurringCheckbox.checked ? 'grid' : 'none';
      };

      // Add collaborator
      window.addCollaborator = function() {
        const emailInput = document.getElementById('collaboratorEmail');
        const email = emailInput.value.trim();
        
        if (!email) {
          document.getElementById('taskError').innerText = 'Please enter an email address.';
          return;
        }
        
        if (!validateEmail(email)) {
          document.getElementById('taskError').innerText = 'Please enter a valid email address.';
          return;
        }
        
        if (collaborators.includes(email)) {
          document.getElementById('taskError').innerText = 'This collaborator has already been added.';
          return;
        }
        
        collaborators.push(email);
        renderCollaborators();
        emailInput.value = '';
        document.getElementById('taskError').innerText = '';
      };

      // Render collaborators list
      function renderCollaborators() {
        const collaboratorsList = document.getElementById('collaboratorsList');
        collaboratorsList.innerHTML = '';
        
        collaborators.forEach((email, index) => {
          const collaboratorElement = document.createElement('div');
          collaboratorElement.className = 'attachment-item';
          collaboratorElement.innerHTML = `
            <i class="fas fa-user"></i>
            <span>${email}</span>
            <button class="btn-danger" style="padding: 2px 5px; margin-left: auto;" onclick="removeCollaborator(${index})">
              <i class="fas fa-times"></i>
            </button>
          `;
          collaboratorsList.appendChild(collaboratorElement);
        });
      }

      // Remove collaborator
      window.removeCollaborator = function(index) {
        collaborators.splice(index, 1);
        renderCollaborators();
      };

      // Validate email format
      function validateEmail(email) {
        const re = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        return re.test(email);
      }

      // Add task
      window.addTask = async function() {
        const taskInput = document.getElementById('taskInput');
        const taskText = taskInput.value.trim();
        const priorityInput = document.getElementById('priorityInput');
        const priority = priorityInput.value;
        const dueDateInput = document.getElementById('dueDateInput');
        const dueDate = dueDateInput.value;
        const descriptionInput = document.getElementById('taskDescription');
        const description = descriptionInput.value.trim();
        const taskError = document.getElementById('taskError');
        const taskSuccess = document.getElementById('taskSuccess');
        const recurringCheckbox = document.getElementById('recurringTask');
        const isRecurring = recurringCheckbox.checked;
        const recurringFrequency = document.getElementById('recurringFrequency').value;
        const recurringInterval = document.getElementById('recurringInterval').value;
        
        taskError.innerText = '';
        taskSuccess.innerText = '';
        
        console.log('Add Task clicked, taskText:', taskText, 'user:', auth.currentUser ? auth.currentUser.uid : 'No user');
        if (!auth.currentUser) {
          taskError.innerText = 'Please sign in to add tasks.';
          console.error('Add Task: No user logged in');
          return;
        }
        if (!taskText) {
          taskError.innerText = 'Task cannot be empty.';
          console.error('Add Task: Empty task input');
          return;
        }
        
        // Show loading state
        const addButton = event.target;
        const originalText = addButton.innerHTML;
        addButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Adding...';
        addButton.disabled = true;
        
        try {
          const userId = auth.currentUser.uid;
          const taskRef = ref(database, `tasks/${userId}`);
          
          let fileUrl = '';
          // Upload file if attached
          if (attachedFile) {
            const fileRef = storageRef(storage, `tasks/${userId}/${Date.now()}_${attachedFile.name}`);
            const snapshot = await uploadBytes(fileRef, attachedFile);
            fileUrl = await getDownloadURL(snapshot.ref);
          }
          
          const taskData = {
            text: taskText,
            completed: false,
            priority: priority,
            dueDate: dueDate,
            description: description,
            category: selectedCategory,
            collaborators: collaborators,
            attachment: fileUrl,
            attachmentName: attachedFile ? attachedFile.name : '',
            timestamp: serverTimestamp(),
            order: allTasks.length, // For drag and drop ordering
            isRecurring: isRecurring,
            recurringFrequency: isRecurring ? recurringFrequency : null,
            recurringInterval: isRecurring ? parseInt(recurringInterval) : null
          };
          
          await push(taskRef, taskData);
          taskInput.value = '';
          descriptionInput.value = '';
          document.getElementById('filePreview').innerHTML = '';
          attachedFile = null;
          collaborators = [];
          renderCollaborators();
          taskSuccess.innerText = 'Task added successfully!';
          
          // Reset recurring options
          recurringCheckbox.checked = false;
          document.getElementById('recurringOptions').style.display = 'none';
          
          console.log('Task added successfully:', taskText);
        } catch (error) {
          taskError.innerText = error.message;
          console.error('Add Task error:', error);
        } finally {
          // Reset button
          addButton.innerHTML = originalText;
          addButton.disabled = false;
        }
      };

      // File upload preview
      window.previewFile = function() {
        const fileInput = document.getElementById('fileInput');
        const filePreview = document.getElementById('filePreview');
        
        if (fileInput.files.length > 0) {
          attachedFile = fileInput.files[0];
          if (attachedFile.type.startsWith('image/')) {
            const reader = new FileReader();
            reader.onload = function(e) {
              filePreview.innerHTML = `<img src="${e.target.result}" alt="Preview" style="max-width: 100%; max-height: 200px;">`;
            };
            reader.readAsDataURL(attachedFile);
          } else {
            filePreview.innerHTML = `<div class="attachment-item">
              <i class="fas fa-file"></i>
              <span>${attachedFile.name}</span>
            </div>`;
          }
        }
      };

      // Search tasks
      window.searchTasks = function() {
        const searchTerm = document.getElementById('searchInput').value.toLowerCase();
        if (!searchTerm) {
          renderTasks(allTasks);
          return;
        }
        
        const filteredTasks = allTasks.filter(task => 
          task.text.toLowerCase().includes(searchTerm) || 
          (task.description && task.description.toLowerCase().includes(searchTerm)) ||
          (task.category && task.category.toLowerCase().includes(searchTerm))
        );
        
        renderTasks(filteredTasks);
      };

      // Change filter
      window.changeFilter = function(filter) {
        currentFilter = filter;
        
        // Update active button
        document.querySelectorAll('.filter-btn').forEach(btn => {
          btn.classList.remove('active');
        });
        event.target.classList.add('active');
        
        // Re-render tasks with new filter
        renderTasks(allTasks);
      };

      // Toggle calendar view
      window.toggleCalendarView = function() {
        const calendarView = document.getElementById('calendarView');
        if (currentView === 'list') {
          calendarView.style.display = 'block';
          currentView = 'calendar';
          renderCalendar();
          event.target.innerHTML = '<i class="fas fa-list"></i> List View';
        } else {
          calendarView.style.display = 'none';
          currentView = 'list';
          event.target.innerHTML = '<i class="fas fa-calendar"></i> Calendar View';
        }
      };

      // Render calendar
      function renderCalendar() {
        const calendarGrid = document.getElementById('calendarGrid');
        const monthNames = ["January", "February", "March", "April", "May", "June",
          "July", "August", "September", "October", "November", "December"
        ];
        
        document.getElementById('calendarMonth').textContent = `${monthNames[currentMonth]} ${currentYear}`;
        
        // Clear previous calendar
        calendarGrid.innerHTML = '';
        
        // Add day headers
        const days = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
        days.forEach(day => {
          const dayElement = document.createElement('div');
          dayElement.className = 'calendar-day day-header';
          dayElement.textContent = day;
          calendarGrid.appendChild(dayElement);
        });
        
        // Get first day of month and number of days
        const firstDay = new Date(currentYear, currentMonth, 1).getDay();
        const daysInMonth = new Date(currentYear, currentMonth + 1, 0).getDate();
        
        // Add empty cells for days before the first day of the month
        for (let i = 0; i < firstDay; i++) {
          const emptyDay = document.createElement('div');
          emptyDay.className = 'calendar-day';
          calendarGrid.appendChild(emptyDay);
        }
        
        // Add cells for each day of the month
        for (let day = 1; day <= daysInMonth; day++) {
          const dayElement = document.createElement('div');
          dayElement.className = 'calendar-day';
          dayElement.innerHTML = `<div>${day}</div>`;
          
          // Check if day has tasks
          const dateStr = `${currentYear}-${String(currentMonth + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
          const dayTasks = allTasks.filter(task => task.dueDate === dateStr);
          
          if (dayTasks.length > 0) {
            dayElement.classList.add('has-tasks');
            dayElement.innerHTML += `<span class="task-count">${dayTasks.length}</span>`;
          }
          
          // Add click event to show tasks for that day
          dayElement.addEventListener('click', () => {
            showTasksForDate(dateStr);
          });
          
          calendarGrid.appendChild(dayElement);
        }
      }

      // Show tasks for a specific date
      function showTasksForDate(dateStr) {
        const filteredTasks = allTasks.filter(task => task.dueDate === dateStr);
        renderTasks(filteredTasks);
        
        // Highlight selected date
        document.querySelectorAll('.calendar-day').forEach(day => {
          day.classList.remove('active');
        });
        event.target.classList.add('active');
      }

      // Navigate to previous month
      window.prevMonth = function() {
        currentMonth--;
        if (currentMonth < 0) {
          currentMonth = 11;
          currentYear--;
        }
        renderCalendar();
      }

      // Navigate to next month
      window.nextMonth = function() {
        currentMonth++;
        if (currentMonth > 11) {
          currentMonth = 0;
          currentYear++;
        }
        renderCalendar();
      }

      // Update task statistics
      function updateTaskStats(tasks) {
        const totalTasks = tasks.length;
        const completedTasks = tasks.filter(task => task.completed).length;
        const overdueTasks = tasks.filter(task => {
          if (task.completed || !task.dueDate) return false;
          const dueDate = new Date(task.dueDate);
          const today = new Date();
          today.setHours(0, 0, 0, 0);
          return dueDate < today;
        }).length;
        
        const productivityRate = totalTasks > 0 ? Math.round((completedTasks / totalTasks) * 100) : 0;
        
        document.getElementById('totalTasks').textContent = totalTasks;
        document.getElementById('completedTasks').textContent = completedTasks;
        document.getElementById('overdueTasks').textContent = overdueTasks;
        document.getElementById('productivityRate').textContent = `${productivityRate}%`;
      }

      // Render tasks based on current filter
      function renderTasks(tasks) {
        const taskList = document.getElementById('taskList');
        taskList.innerHTML = '';
        
        // Apply filter
        let filteredTasks = tasks;
        if (currentFilter === 'active') {
          filteredTasks = tasks.filter(task => !task.completed);
        } else if (currentFilter === 'completed') {
          filteredTasks = tasks.filter(task => task.completed);
        } else if (currentFilter === 'high') {
          filteredTasks = tasks.filter(task => task.priority === 'high');
        } else if (currentFilter === 'overdue') {
          filteredTasks = tasks.filter(task => {
            if (task.completed || !task.dueDate) return false;
            const dueDate = new Date(task.dueDate);
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            return dueDate < today;
          });
        }
        
        // Sort by order (for drag and drop)
        filteredTasks.sort((a, b) => (a.order || 0) - (b.order || 0));
        
        if (filteredTasks.length === 0) {
          taskList.innerHTML = `
            <div class="empty-state">
              <i class="fas fa-clipboard-list"></i>
              <p>No tasks found</p>
            </div>
          `;
          return;
        }
        
        filteredTasks.forEach(task => {
          const li = document.createElement('li');
          li.setAttribute('data-id', task.id);
          li.draggable = true;
          
          // Add drag and drop event listeners
          li.addEventListener('dragstart', handleDragStart);
          li.addEventListener('dragover', handleDragOver);
          li.addEventListener('drop', handleDrop);
          li.addEventListener('dragend', handleDragEnd);
          
          // Color code by due date proximity
          if (task.dueDate && !task.completed) {
            const dueDate = new Date(task.dueDate);
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const timeDiff = dueDate.getTime() - today.getTime();
            const daysDiff = Math.ceil(timeDiff / (1000 * 3600 * 24));
            
            if (daysDiff < 0) {
              li.classList.add('due-date-proximity-urgent');
            } else if (daysDiff <= 2) {
              li.classList.add('due-date-proximity-soon');
            } else if (daysDiff <= 7) {
              li.classList.add('due-date-proximity-future');
            }
          }
          
          // Color code by priority
          if (task.priority === 'high') {
            li.style.borderLeftColor = '#d63031';
          } else if (task.priority === 'medium') {
            li.style.borderLeftColor = '#fdcb6e';
          } else {
            li.style.borderLeftColor = '#00b894';
          }
          
          if (task.completed) {
            li.classList.add('completed');
          }
          
          const formattedDate = task.dueDate ? new Date(task.dueDate).toLocaleDateString() : 'No due date';
          
          // Build task details HTML
          let taskDetailsHtml = `<div>${formattedDate}</div>`;
          
          if (task.category) {
            taskDetailsHtml += `<span class="category-tag">${task.category}</span>`;
          }
          
          if (task.isRecurring) {
            taskDetailsHtml += `<span class="recurring-badge">${task.recurringFrequency}</span>`;
          }
          
          taskDetailsHtml += `<span class="task-priority priority-${task.priority}">${task.priority.toUpperCase()}</span>`;
          
          // Add collaborators if any
          if (task.collaborators && task.collaborators.length > 0) {
            taskDetailsHtml += `<div style="margin-top: 5px;">`;
            task.collaborators.forEach(email => {
              const initial = email.charAt(0).toUpperCase();
              taskDetailsHtml += `<span class="collaborator-avatar" title="${email}">${initial}</span>`;
            });
            taskDetailsHtml += `</div>`;
          }
          
          li.innerHTML = `
            <div>
              <input type="checkbox" ${task.completed ? 'checked' : ''} onchange="toggleTaskCompletion('${task.id}')" />
            </div>
            <div class="task-text" onclick="showTaskDetails('${task.id}')">${task.text}</div>
            <div class="task-details">
              ${taskDetailsHtml}
            </div>
            <div class="task-actions">
              <button class="btn-warning" onclick="editTask('${task.id}')" title="Edit Task">
                <i class="fas fa-edit"></i>
              </button>
              <button class="btn-danger" onclick="deleteTask('${task.id}')" title="Delete Task">
                <i class="fas fa-trash"></i>
              </button>
            </div>
          `;
          
          taskList.appendChild(li);
        });
      }

      // Toggle task completion
      window.toggleTaskCompletion = async function(taskId) {
        try {
          const userId = auth.currentUser.uid;
          const taskRef = ref(database, `tasks/${userId}/${taskId}`);
          const task = allTasks.find(t => t.id === taskId);
          
          await update(taskRef, {
            completed: !task.completed
          });
          
          // Add animation effect
          const taskElement = document.querySelector(`li[data-id="${taskId}"]`);
          taskElement.classList.add('task-complete-animation');
          setTimeout(() => {
            taskElement.classList.remove('task-complete-animation');
          }, 500);
          
          console.log('Task completion toggled for task:', taskId);
        } catch (error) {
          document.getElementById('taskError').innerText = error.message;
          console.error('Toggle task completion error:', error);
        }
      };

      // Edit task
      window.editTask = function(taskId) {
        const task = allTasks.find(t => t.id === taskId);
        if (!task) return;
        
        // Populate the form with task details
        document.getElementById('taskInput').value = task.text;
        document.getElementById('dueDateInput').value = task.dueDate || '';
        document.getElementById('priorityInput').value = task.priority;
        document.getElementById('taskDescription').value = task.description || '';
        
        // Select category
        if (task.category) {
          document.querySelectorAll('.category-option').forEach(option => {
            option.classList.remove('selected');
            if (option.getAttribute('data-category') === task.category) {
              option.classList.add('selected');
              selectedCategory = task.category;
            }
          });
        }
        
        // Set recurring options if applicable
        if (task.isRecurring) {
          document.getElementById('recurringTask').checked = true;
          document.getElementById('recurringOptions').style.display = 'grid';
          document.getElementById('recurringFrequency').value = task.recurringFrequency;
          document.getElementById('recurringInterval').value = task.recurringInterval;
        } else {
          document.getElementById('recurringTask').checked = false;
          document.getElementById('recurringOptions').style.display = 'none';
        }
        
        // Set collaborators
        if (task.collaborators) {
          collaborators = [...task.collaborators];
          renderCollaborators();
        }
        
        // Show file if exists
        const filePreview = document.getElementById('filePreview');
        if (task.attachment) {
          if (task.attachmentName.match(/\.(jpg|jpeg|png|gif)$/i)) {
            filePreview.innerHTML = `<img src="${task.attachment}" alt="Preview" style="max-width: 100%; max-height: 200px;">`;
          } else {
            filePreview.innerHTML = `<div class="attachment-item">
              <i class="fas fa-file"></i>
              <span>${task.attachmentName}</span>
            </div>`;
          }
          attachedFile = { name: task.attachmentName }; // Simulate file object
        } else {
          filePreview.innerHTML = '';
          attachedFile = null;
        }
        
        // Change button to "Update Task"
        const addButton = document.querySelector('.btn-accent');
        addButton.innerHTML = '<i class="fas fa-save"></i> Update Task';
        addButton.onclick = function() { updateTask(taskId); };
        
        // Scroll to form
        document.getElementById('taskInput').focus();
        currentEditingTaskId = taskId;
        
        console.log('Editing task:', taskId);
      };

      // Update task
      window.updateTask = async function(taskId) {
        const taskInput = document.getElementById('taskInput');
        const taskText = taskInput.value.trim();
        const priorityInput = document.getElementById('priorityInput');
        const priority = priorityInput.value;
        const dueDateInput = document.getElementById('dueDateInput');
        const dueDate = dueDateInput.value;
        const descriptionInput = document.getElementById('taskDescription');
        const description = descriptionInput.value.trim();
        const taskError = document.getElementById('taskError');
        const taskSuccess = document.getElementById('taskSuccess');
        const recurringCheckbox = document.getElementById('recurringTask');
        const isRecurring = recurringCheckbox.checked;
        const recurringFrequency = document.getElementById('recurringFrequency').value;
        const recurringInterval = document.getElementById('recurringInterval').value;
        
        taskError.innerText = '';
        taskSuccess.innerText = '';
        
        if (!taskText) {
          taskError.innerText = 'Task cannot be empty.';
          return;
        }
        
        // Show loading state
        const updateButton = event.target;
        const originalText = updateButton.innerHTML;
        updateButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Updating...';
        updateButton.disabled = true;
        
        try {
          const userId = auth.currentUser.uid;
          const taskRef = ref(database, `tasks/${userId}/${taskId}`);
          
          let fileUrl = '';
          let fileName = '';
          
          // If a new file is attached, upload it
          if (attachedFile && attachedFile.name) {
            // Delete old file if exists
            const oldTask = allTasks.find(t => t.id === taskId);
            if (oldTask.attachment) {
              const oldFileRef = storageRef(storage, oldTask.attachment);
              try {
                await deleteObject(oldFileRef);
              } catch (error) {
                console.error('Error deleting old file:', error);
              }
            }
            
            // Upload new file
            const fileRef = storageRef(storage, `tasks/${userId}/${Date.now()}_${attachedFile.name}`);
            const snapshot = await uploadBytes(fileRef, attachedFile);
            fileUrl = await getDownloadURL(snapshot.ref);
            fileName = attachedFile.name;
          } else {
            // Keep existing file if no new file is attached
            const oldTask = allTasks.find(t => t.id === taskId);
            fileUrl = oldTask.attachment || '';
            fileName = oldTask.attachmentName || '';
          }
          
          await update(taskRef, {
            text: taskText,
            priority: priority,
            dueDate: dueDate,
            description: description,
            category: selectedCategory,
            collaborators: collaborators,
            attachment: fileUrl,
            attachmentName: fileName,
            isRecurring: isRecurring,
            recurringFrequency: isRecurring ? recurringFrequency : null,
            recurringInterval: isRecurring ? parseInt(recurringInterval) : null
          });
          
          // Reset form
          taskInput.value = '';
          descriptionInput.value = '';
          document.getElementById('filePreview').innerHTML = '';
          attachedFile = null;
          collaborators = [];
          renderCollaborators();
          taskSuccess.innerText = 'Task updated successfully!';
          
          // Reset recurring options
          recurringCheckbox.checked = false;
          document.getElementById('recurringOptions').style.display = 'none';
          
          // Change button back to "Add Task"
          const addButton = document.querySelector('.btn-accent');
          addButton.innerHTML = '<i class="fas fa-plus-circle"></i> Add Task';
          addButton.onclick = function() { addTask(); };
          
          currentEditingTaskId = null;
          console.log('Task updated successfully:', taskId);
        } catch (error) {
          taskError.innerText = error.message;
          console.error('Update task error:', error);
        } finally {
          // Reset button
          updateButton.innerHTML = originalText;
          updateButton.disabled = false;
        }
      };

      // Delete task
      window.deleteTask = async function(taskId) {
        if (!confirm('Are you sure you want to delete this task?')) {
          return;
        }
        
        try {
          const userId = auth.currentUser.uid;
          const taskRef = ref(database, `tasks/${userId}/${taskId}`);
          
          // Delete attached file if exists
          const task = allTasks.find(t => t.id === taskId);
          if (task.attachment) {
            const fileRef = storageRef(storage, task.attachment);
            try {
              await deleteObject(fileRef);
            } catch (error) {
              console.error('Error deleting file:', error);
            }
          }
          
          await remove(taskRef);
          console.log('Task deleted successfully:', taskId);
        } catch (error) {
          document.getElementById('taskError').innerText = error.message;
          console.error('Delete task error:', error);
        }
      };

      // Drag and Drop functions
      function handleDragStart(e) {
        currentDraggedTask = this;
        this.classList.add('dragging');
        e.dataTransfer.effectAllowed = 'move';
        e.dataTransfer.setData('text/plain', this.getAttribute('data-id'));
      }

      function handleDragOver(e) {
        e.preventDefault();
        e.dataTransfer.dropEffect = 'move';
        return false;
      }

      function handleDrop(e) {
        e.preventDefault();
        if (currentDraggedTask !== this) {
          // Get task IDs
          const draggedTaskId = currentDraggedTask.getAttribute('data-id');
          const targetTaskId = this.getAttribute('data-id');
          
          // Find task indices
          const draggedIndex = allTasks.findIndex(task => task.id === draggedTaskId);
          const targetIndex = allTasks.findIndex(task => task.id === targetTaskId);
          
          if (draggedIndex !== -1 && targetIndex !== -1) {
            // Reorder tasks array
            const [movedTask] = allTasks.splice(draggedIndex, 1);
            allTasks.splice(targetIndex, 0, movedTask);
            
            // Update order in database
            updateTaskOrder();
          }
        }
        return false;
      }

      function handleDragEnd() {
        this.classList.remove('dragging');
      }

      // Update task order in database
      async function updateTaskOrder() {
        try {
          const userId = auth.currentUser.uid;
          
          for (let i = 0; i < allTasks.length; i++) {
            const taskRef = ref(database, `tasks/${userId}/${allTasks[i].id}`);
            await update(taskRef, {
              order: i
            });
          }
          
          console.log('Task order updated');
        } catch (error) {
          document.getElementById('taskError').innerText = error.message;
          console.error('Update task order error:', error);
        }
      }

      // Show task details in modal
      window.showTaskDetails = function(taskId) {
        const task = allTasks.find(t => t.id === taskId);
        if (!task) return;
        
        const modalContent = document.getElementById('modalTaskContent');
        const formattedDate = task.dueDate ? new Date(task.dueDate).toLocaleDateString() : 'No due date';
        
        let attachmentHtml = '';
        if (task.attachment) {
          if (task.attachmentName.match(/\.(jpg|jpeg|png|gif)$/i)) {
            attachmentHtml = `<div class="attachment-item">
              <img src="${task.attachment}" alt="Attachment" style="max-width: 100%;">
            </div>`;
          } else {
            attachmentHtml = `<div class="attachment-item">
              <i class="fas fa-file"></i>
              <a href="${task.attachment}" target="_blank">${task.attachmentName}</a>
            </div>`;
          }
        }
        
        let collaboratorsHtml = '';
        if (task.collaborators && task.collaborators.length > 0) {
          collaboratorsHtml = `<p><strong>Collaborators:</strong><br>`;
          task.collaborators.forEach(email => {
            collaboratorsHtml += `<span class="collaborator-avatar" title="${email}">${email.charAt(0).toUpperCase()}</span> ${email}<br>`;
          });
          collaboratorsHtml += `</p>`;
        }
        
        modalContent.innerHTML = `
          <h4>${task.text}</h4>
          <p><strong>Priority:</strong> <span class="task-priority priority-${task.priority}">${task.priority.toUpperCase()}</span></p>
          <p><strong>Due Date:</strong> ${formattedDate}</p>
          <p><strong>Category:</strong> ${task.category || 'None'}</p>
          <p><strong>Description:</strong> ${task.description || 'No description'}</p>
          ${task.isRecurring ? `<p><strong>Recurring:</strong> Every ${task.recurringInterval} ${task.recurringFrequency}</p>` : ''}
          ${collaboratorsHtml}
          ${attachmentHtml}
        `;
        
        document.getElementById('taskDetailModal').style.display = 'flex';
      };

      // Close modal
      window.closeModal = function() {
        document.getElementById('taskDetailModal').style.display = 'none';
      }

      // Close modal if clicked outside
      window.onclick = function(event) {
        const modal = document.getElementById('taskDetailModal');
        if (event.target === modal) {
          closeModal();
        }
      }

      // Toggle notifications dropdown
      window.toggleNotifications = function() {
        const dropdown = document.getElementById('notificationDropdown');
        dropdown.style.display = dropdown.style.display === 'block' ? 'none' : 'block';
      };

      // Check for notifications
      function checkNotifications(tasks) {
        notifications = [];
        const now = new Date();
        
        tasks.forEach(task => {
          if (task.dueDate && !task.completed) {
            const dueDate = new Date(task.dueDate);
            const timeDiff = dueDate.getTime() - now.getTime();
            const hoursDiff = timeDiff / (1000 * 3600);
            
            // Notify if task is due within 24 hours
            if (hoursDiff <= 24 && hoursDiff > 0) {
              notifications.push({
                type: 'due_soon',
                message: `Task "${task.text}" is due soon!`,
                taskId: task.id
              });
            }
            
            // Notify if task is overdue
            if (hoursDiff < 0) {
              notifications.push({
                type: 'overdue',
                message: `Task "${task.text}" is overdue!`,
                taskId: task.id
              });
            }
          }
        });
        
        // Update notification badge
        const badge = document.getElementById('notificationBadge');
        if (notifications.length > 0) {
          badge.style.display = 'flex';
          badge.textContent = notifications.length;
        } else {
          badge.style.display = 'none';
        }
        
        // Update notification list
        const notificationList = document.getElementById('notificationList');
        if (notifications.length > 0) {
          notificationList.innerHTML = '';
          notifications.forEach(notification => {
            const notificationItem = document.createElement('div');
            notificationItem.className = 'notification-item';
            notificationItem.innerHTML = notification.message;
            notificationItem.style.cursor = 'pointer';
            notificationItem.addEventListener('click', () => {
              showTaskDetails(notification.taskId);
              document.getElementById('notificationDropdown').style.display = 'none';
            });
            notificationList.appendChild(notificationItem);
          });
        } else {
          notificationList.innerHTML = '<div class="notification-item">No notifications</div>';
        }
      }

      // Show settings panel
      window.showSettings = function() {
        const settingsPanel = document.getElementById('settingsPanel');
        settingsPanel.style.display = settingsPanel.style.display === 'block' ? 'none' : 'block';
      };

      // Load user settings
      function loadUserSettings(userId) {
        const settingsRef = ref(database, `settings/${userId}`);
        
        onValue(settingsRef, snapshot => {
          if (snapshot.exists()) {
            userSettings = snapshot.val();
            
            // Apply settings
            if (userSettings.emailNotifications !== undefined) {
              document.getElementById('emailNotifications').checked = userSettings.emailNotifications;
            }
            
            if (userSettings.reminderTime !== undefined) {
              document.getElementById('reminderTime').value = userSettings.reminderTime;
            }
          }
        });
      }

      // Save settings
      window.saveSettings = async function() {
        try {
          const userId = auth.currentUser.uid;
          const settingsRef = ref(database, `settings/${userId}`);
          
          const newSettings = {
            emailNotifications: document.getElementById('emailNotifications').checked,
            reminderTime: parseInt(document.getElementById('reminderTime').value)
          };
          
          await set(settingsRef, newSettings);
          userSettings = newSettings;
          
          document.getElementById('taskSuccess').innerText = 'Settings saved successfully!';
          console.log('Settings saved');
        } catch (error) {
          document.getElementById('taskError').innerText = error.message;
          console.error('Save settings error:', error);
        }
      };

      // Export data
      window.exportData = function(format) {
        const userId = auth.currentUser.uid;
        const dataToExport = allTasks.filter(task => !task.completed);
        
        let dataStr, fileName, mimeType;
        
        if (format === 'json') {
          dataStr = JSON.stringify(dataToExport, null, 2);
          fileName = `xee-pro-tasks-${new Date().toISOString().split('T')[0]}.json`;
          mimeType = 'application/json';
        } else if (format === 'csv') {
          // Convert to CSV
          const headers = ['Task', 'Priority', 'Due Date', 'Category', 'Description'];
          const csvData = dataToExport.map(task => [
            `"${task.text.replace(/"/g, '""')}"`,
            task.priority,
            task.dueDate || '',
            task.category || '',
            `"${(task.description || '').replace(/"/g, '""')}"`
          ]);
          
          dataStr = [headers, ...csvData].map(row => row.join(',')).join('\n');
          fileName = `xee-pro-tasks-${new Date().toISOString().split('T')[0]}.csv`;
          mimeType = 'text/csv';
        }
        
        // Create download link
        const blob = new Blob([dataStr], { type: mimeType });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = fileName;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
        
        document.getElementById('taskSuccess').innerText = `Data exported as ${format.toUpperCase()} successfully!`;
        console.log('Data exported:', format);
      };

    } catch (error) {
      console.error('Firebase initialization error:', error);
      document.getElementById('error').innerText = 'Failed to initialize the app. Please check your connection.';
    }
  </script>
</body>
</html>