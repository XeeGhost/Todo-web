<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Xee Pro - Task Management</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    :root {
      --primary: #6c5ce7;
      --primary-dark: #5649c5;
      --secondary: #a29bfe;
      --accent: #fd79a8;
      --light: #f8f9fa;
      --dark: #2d3436;
      --success: #00b894;
      --warning: #fdcb6e;
      --danger: #d63031;
      --gray: #dfe6e9;
      --dark-gray: #636e72;
      --card-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
      --transition: all 0.3s ease;
      --bg-color: white;
      --text-color: #2d3436;
      --card-bg: white;
      --input-bg: white;
      --border-color: #dfe6e9;
    }

    [data-theme="dark"] {
      --bg-color: #1a1c23;
      --text-color: #f8f9fa;
      --card-bg: #2d3038;
      --input-bg: #3a3d46;
      --border-color: #444752;
      --gray: #444752;
      --dark-gray: #a0a5b1;
      --card-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
      min-height: 100vh;
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 20px;
      color: var(--text-color);
      background-color: var(--bg-color);
      transition: var(--transition);
    }

    [data-theme="dark"] body {
      background: linear-gradient(135deg, #1a1c23 0%, #2d3038 100%);
    }

    .container {
      background: var(--card-bg);
      padding: 30px;
      border-radius: 20px;
      box-shadow: var(--card-shadow);
      width: 100%;
      max-width: 1000px;
      transition: var(--transition);
    }

    .app-header {
      text-align: center;
      margin-bottom: 25px;
      position: relative;
    }

    .app-header h1 {
      color: var(--primary);
      font-size: 32px;
      margin-bottom: 5px;
      font-weight: 700;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
    }

    .app-header p {
      color: var(--text-color);
      opacity: 0.7;
      font-size: 14px;
    }

    .auth-section, .todo-section {
      transition: var(--transition);
    }

    .dashboard {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 15px;
      margin-bottom: 30px;
    }

    .stat-card {
      background: var(--card-bg);
      padding: 20px;
      border-radius: 12px;
      box-shadow: var(--card-shadow);
      text-align: center;
    }

    .stat-value {
      font-size: 28px;
      font-weight: 700;
      color: var(--primary);
      margin-bottom: 5px;
    }

    .stat-label {
      font-size: 14px;
      color: var(--dark-gray);
    }

    .productivity-card {
      background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
      color: white;
    }

    .productivity-card .stat-value,
    .productivity-card .stat-label {
      color: white;
    }

    .divider {
      height: 1px;
      background: var(--gray);
      margin: 25px 0;
    }

    .section-title {
      font-size: 20px;
      font-weight: 600;
      margin-bottom: 20px;
      color: var(--text-color);
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .section-title i {
      color: var(--primary);
    }

    .task-form {
      display: grid;
      grid-template-columns: 2fr 1fr 1fr;
      gap: 15px;
      margin-bottom: 25px;
    }

    .input-group {
      position: relative;
    }

    .input-group i {
      position: absolute;
      left: 15px;
      top: 50%;
      transform: translateY(-50%);
      color: var(--secondary);
      z-index: 1;
    }

    input[type="email"], input[type="password"], input[type="text"], 
    input[type="date"], select, textarea {
      width: 100%;
      padding: 15px 15px 15px 45px;
      border: 2px solid var(--border-color);
      border-radius: 10px;
      font-size: 16px;
      transition: var(--transition);
      background-color: var(--input-bg);
      color: var(--text-color);
    }

    textarea {
      min-height: 100px;
      resize: vertical;
    }

    input:focus, select:focus, textarea:focus {
      border-color: var(--primary);
      outline: none;
      box-shadow: 0 0 0 3px rgba(108, 92, 231, 0.2);
    }

    .btn-group {
      display: flex;
      gap: 10px;
      margin-top: 20px;
    }

    button {
      padding: 12px 20px;
      border: none;
      border-radius: 10px;
      cursor: pointer;
      font-size: 16px;
      font-weight: 600;
      transition: var(--transition);
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }

    .btn-primary {
      background-color: var(--primary);
      color: white;
      flex: 1;
    }

    .btn-primary:hover {
      background-color: var(--primary-dark);
      transform: translateY(-2px);
    }

    .btn-secondary {
      background-color: var(--secondary);
      color: white;
      flex: 1;
    }

    .btn-secondary:hover {
      background-color: #9186fd;
      transform: translateY(-2px);
    }

    .btn-danger {
      background-color: var(--danger);
      color: white;
    }

    .btn-danger:hover {
      background-color: #c02b2b;
      transform: translateY(-2px);
    }

    .btn-success {
      background-color: var(--success);
      color: white;
    }

    .btn-success:hover {
      background-color: #00a382;
      transform: translateY(-2px);
    }

    .btn-accent {
      background-color: var(--accent);
      color: white;
      padding: 10px 15px;
    }

    .btn-accent:hover {
      background-color: #fc6ba7;
      transform: translateY(-2px);
    }

    .btn-warning {
      background-color: var(--warning);
      color: var(--dark);
    }

    .btn-warning:hover {
      background-color: #f5b84d;
      transform: translateY(-2px);
    }

    .error {
      color: var(--danger);
      font-size: 14px;
      margin: 10px 0;
      text-align: center;
      min-height: 20px;
    }

    .task-filters {
      display: flex;
      gap: 10px;
      margin-bottom: 15px;
      flex-wrap: wrap;
    }

    .filter-btn {
      background: none;
      border: 2px solid var(--border-color);
      color: var(--text-color);
      padding: 8px 15px;
      font-size: 14px;
      border-radius: 20px;
    }

    .filter-btn.active {
      background-color: var(--primary);
      color: white;
      border-color: var(--primary);
    }

    ul {
      list-style: none;
      margin: 20px 0;
      max-height: 350px;
      overflow-y: auto;
      padding-right: 5px;
    }

    li {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 15px;
      margin-bottom: 10px;
      border-radius: 10px;
      background-color: var(--card-bg);
      transition: var(--transition);
      animation: fadeIn 0.5s ease;
      cursor: grab;
      border-left: 4px solid;
    }

    li:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
    }

    li.dragging {
      opacity: 0.5;
      background-color: var(--secondary);
    }

    li.completed {
      background-color: rgba(0, 184, 148, 0.1);
    }

    li.completed .task-text {
      text-decoration: line-through;
      color: #777;
    }

    .task-text {
      flex: 1;
      padding: 0 15px;
      word-break: break-word;
    }

    .task-details {
      display: flex;
      flex-direction: column;
      gap: 5px;
      font-size: 12px;
      color: var(--dark-gray);
    }

    .task-priority {
      display: inline-block;
      padding: 3px 8px;
      border-radius: 20px;
      font-size: 11px;
      font-weight: bold;
    }

    .priority-high {
      background-color: rgba(214, 48, 49, 0.1);
      color: var(--danger);
    }

    .priority-medium {
      background-color: rgba(253, 203, 110, 0.1);
      color: var(--warning);
    }

    .priority-low {
      background-color: rgba(0, 184, 148, 0.1);
      color: var(--success);
    }

    .task-actions {
      display: flex;
      gap: 5px;
    }

    .empty-state {
      text-align: center;
      padding: 30px;
      color: #999;
    }

    .empty-state i {
      font-size: 50px;
      margin-bottom: 15px;
      color: var(--secondary);
    }

    .user-info {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 20px;
      padding-bottom: 15px;
      border-bottom: 1px solid var(--border-color);
    }

    .user-email {
      font-weight: 500;
      color: var(--primary);
      overflow: hidden;
      text-overflow: ellipsis;
      max-width: 200px;
    }

    .theme-toggle {
      background: none;
      border: none;
      font-size: 24px;
      cursor: pointer;
      color: var(--text-color);
      margin-left: 15px;
    }

    .search-container {
      position: relative;
      margin-bottom: 20px;
    }

    .search-container i {
      position: absolute;
      left: 15px;
      top: 50%;
      transform: translateY(-50%);
      color: var(--secondary);
    }

    .search-container input {
      padding-left: 45px;
    }

    .calendar-view {
      margin-top: 20px;
    }

    .calendar-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
    }

    .calendar-grid {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 5px;
    }

    .calendar-day {
      padding: 10px;
      border-radius: 8px;
      text-align: center;
      background-color: var(--card-bg);
      min-height: 80px;
      cursor: pointer;
      transition: var(--transition);
    }

    .calendar-day:hover {
      background-color: var(--secondary);
      color: white;
    }

    .calendar-day.active {
      background-color: var(--primary);
      color: white;
    }

    .calendar-day.has-tasks {
      border-bottom: 3px solid var(--accent);
    }

    .day-header {
      font-weight: bold;
      margin-bottom: 5px;
    }

    .task-count {
      font-size: 12px;
      background-color: var(--accent);
      color: white;
      border-radius: 50%;
      width: 20px;
      height: 20px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
    }

    .task-detail-modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.5);
      z-index: 1000;
      justify-content: center;
      align-items: center;
    }

    .modal-content {
      background-color: var(--card-bg);
      padding: 30px;
      border-radius: 15px;
      width: 90%;
      max-width: 500px;
      box-shadow: var(--card-shadow);
    }

    .close-modal {
      float: right;
      font-size: 24px;
      cursor: pointer;
    }

    .file-upload {
      margin-top: 15px;
    }

    .file-preview {
      margin-top: 10px;
      max-width: 100%;
      max-height: 200px;
    }

    .attachment-item {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-top: 10px;
      padding: 5px;
      background-color: var(--input-bg);
      border-radius: 5px;
    }

    .due-date-proximity-urgent {
      border-left-color: var(--danger) !important;
    }

    .due-date-proximity-soon {
      border-left-color: var(--warning) !important;
    }

    .due-date-proximity-future {
      border-left-color: var(--success) !important;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    /* Scrollbar styling */
    ::-webkit-scrollbar {
      width: 8px;
    }

    ::-webkit-scrollbar-track {
      background: #f1f1f1;
      border-radius: 10px;
    }

    ::-webkit-scrollbar-thumb {
      background: var(--secondary);
      border-radius: 10px;
    }

    ::-webkit-scrollbar-thumb:hover {
      background: var(--primary);
    }

    [data-theme="dark"] ::-webkit-scrollbar-track {
      background: #2d3038;
    }

    /* Mobile-specific styles */
    @media (max-width: 768px) {
      body {
        padding: 10px;
        align-items: flex-start;
        min-height: 100vh;
        height: auto;
      }
      
      .container {
        padding: 20px;
        border-radius: 15px;
        margin: 10px 0;
      }
      
      .dashboard {
        grid-template-columns: repeat(2, 1fr);
      }
      
      .app-header h1 {
        font-size: 28px;
      }
      
      .task-form {
        grid-template-columns: 1fr;
      }
      
      .btn-group {
        flex-direction: column;
      }
      
      .task-filters {
        justify-content: center;
      }
      
      .user-info {
        flex-direction: column;
        align-items: flex-start;
        gap: 10px;
      }
      
      .user-email {
        max-width: 100%;
      }
      
      li {
        flex-direction: column;
        align-items: flex-start;
        gap: 10px;
      }
      
      .task-actions {
        align-self: flex-end;
      }
      
      input[type="email"], input[type="password"], input[type="text"], 
      input[type="date"], select {
        font-size: 16px;
      }

      .calendar-grid {
        grid-template-columns: repeat(7, 1fr);
        overflow-x: auto;
      }

      .calendar-day {
        min-width: 40px;
        min-height: 60px;
        font-size: 12px;
      }
    }

    /* Animation for task completion */
    @keyframes taskComplete {
      0% { transform: scale(1); }
      50% { transform: scale(1.05); }
      100% { transform: scale(1); }
    }

    .task-complete-animation {
      animation: taskComplete 0.5s ease;
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- Auth Section -->
    <div class="auth-section" id="authSection">
      <div class="app-header">
        <h1><i class="fas fa-tasks"></i> Xee Pro</h1>
        <p>Professional Task Management</p>
      </div>
      
      <div class="input-group">
        <i class="fas fa-envelope"></i>
        <input type="email" id="email" placeholder="Enter your email" />
      </div>
      
      <div class="input-group">
        <i class="fas fa-lock"></i>
        <input type="password" id="password" placeholder="Enter your password" />
      </div>
      
      <div class="btn-group">
        <button class="btn-primary" onclick="signUp()">
          <i class="fas fa-user-plus"></i> Sign Up
        </button>
        <button class="btn-secondary" onclick="signIn()">
          <i class="fas fa-sign-in-alt"></i> Sign In
        </button>
      </div>
      
      <p class="error" id="error"></p>
    </div>

    <!-- To-Do Section -->
    <div class="todo-section" id="todoSection" style="display: none;">
      <div class="user-info">
        <div>
          <h2>Xee Pro Dashboard</h2>
          <span class="user-email" id="userEmail"></span>
        </div>
        <div style="display: flex; align-items: center;">
          <button class="theme-toggle" id="themeToggle">
            <i class="fas fa-moon"></i>
          </button>
          <button class="btn-danger" onclick="signOut()" title="Sign Out">
            <i class="fas fa-sign-out-alt"></i>
          </button>
        </div>
      </div>
      
      <!-- Search Bar -->
      <div class="search-container">
        <i class="fas fa-search"></i>
        <input type="text" id="searchInput" placeholder="Search tasks..." oninput="searchTasks()" />
      </div>
      
      <!-- Stats Dashboard -->
      <div class="dashboard">
        <div class="stat-card">
          <div class="stat-value" id="totalTasks">0</div>
          <div class="stat-label">Total Tasks</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="completedTasks">0</div>
          <div class="stat-label">Completed</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="overdueTasks">0</div>
          <div class="stat-label">Overdue</div>
        </div>
        <div class="stat-card productivity-card">
          <div class="stat-value" id="productivityRate">0%</div>
          <div class="stat-label">Productivity</div>
        </div>
      </div>

      <div class="divider"></div>
      
      <!-- Calendar View Button -->
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
        <div class="section-title">
          <i class="fas fa-plus-circle"></i> Add New Task
        </div>
        <button class="btn-accent" onclick="toggleCalendarView()">
          <i class="fas fa-calendar"></i> Calendar View
        </button>
      </div>
      
      <div class="task-form">
        <div class="input-group">
          <i class="fas fa-tasks"></i>
          <input type="text" id="taskInput" placeholder="What needs to be done?" />
        </div>
        
        <div class="input-group">
          <i class="fas fa-calendar-day"></i>
          <input type="date" id="dueDateInput" />
        </div>
        
        <div class="input-group">
          <i class="fas fa-flag"></i>
          <select id="priorityInput">
            <option value="low">Low Priority</option>
            <option value="medium" selected>Medium Priority</option>
            <option value="high">High Priority</option>
          </select>
        </div>
      </div>

      <div class="input-group">
        <i class="fas fa-align-left"></i>
        <textarea id="taskDescription" placeholder="Task description (optional)"></textarea>
      </div>

      <div class="file-upload">
        <label for="fileInput" class="btn-warning">
          <i class="fas fa-paperclip"></i> Attach File
        </label>
        <input type="file" id="fileInput" style="display: none;" onchange="previewFile()" />
        <div id="filePreview" class="file-preview"></div>
      </div>
      
      <button class="btn-accent" onclick="addTask()">
        <i class="fas fa-plus-circle"></i> Add Task
      </button>
      
      <p class="error" id="taskError"></p>

      <div class="divider"></div>
      
      <!-- Calendar View -->
      <div class="calendar-view" id="calendarView" style="display: none;">
        <div class="calendar-header">
          <button class="btn-warning" onclick="prevMonth()">
            <i class="fas fa-chevron-left"></i>
          </button>
          <h3 id="calendarMonth">September 2023</h3>
          <button class="btn-warning" onclick="nextMonth()">
            <i class="fas fa-chevron-right"></i>
          </button>
        </div>
        <div class="calendar-grid" id="calendarGrid">
          <!-- Calendar will be generated here -->
        </div>
        <div class="divider"></div>
      </div>
      
      <!-- Task List Section -->
      <div class="section-title">
        <i class="fas fa-list-check"></i> My Tasks
      </div>
      
      <div class="task-filters">
        <button class="filter-btn active" onclick="changeFilter('all')">All</button>
        <button class="filter-btn" onclick="changeFilter('active')">Active</button>
        <button class="filter-btn" onclick="changeFilter('completed')">Completed</button>
        <button class="filter-btn" onclick="changeFilter('high')">High Priority</button>
      </div>
      
      <ul id="taskList"></ul>
    </div>
  </div>

  <!-- Task Detail Modal -->
  <div class="task-detail-modal" id="taskDetailModal">
    <div class="modal-content">
      <span class="close-modal" onclick="closeModal()">&times;</span>
      <h3>Task Details</h3>
      <div id="modalTaskContent"></div>
    </div>
  </div>

  <!-- Firebase SDK (Modular) -->
  <script type="module">
    // Import Firebase SDK modules
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js';
    import { 
      getAuth, 
      createUserWithEmailAndPassword, 
      signInWithEmailAndPassword, 
      signOut, 
      onAuthStateChanged,
      setPersistence,
      browserLocalPersistence
    } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js';
    import { getDatabase, ref, push, set, onValue, update, remove, serverTimestamp } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js';
    import { getStorage, ref as storageRef, uploadBytes, getDownloadURL, deleteObject } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-storage.js';

    // Firebase configuration
    const firebaseConfig = {
      apiKey: "AIzaSyDe8yzLDj8Y-gzHqS2arkwbD989LwIO4DQ",
      authDomain: "todoapp-5d6ec.firebaseapp.com",
      databaseURL: "https://todoapp-5d6ec-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "todoapp-5d6ec",
      storageBucket: "todoapp-5d6ec.firebasestorage.app",
      messagingSenderId: "720430702785",
      appId: "1:720430702785:web:af612a4935cdc731ccb440",
      measurementId: "G-YG48X4LZ97"
    };

    // Initialize Firebase
    try {
      const app = initializeApp(firebaseConfig);
      const auth = getAuth(app);
      const database = getDatabase(app);
      const storage = getStorage(app);
      console.log('Firebase initialized successfully');

      // Set authentication persistence
      setPersistence(auth, browserLocalPersistence)
        .then(() => {
          console.log("Auth persistence set to LOCAL (user stays logged in between sessions)");
        })
        .catch((error) => {
          console.error("Error setting auth persistence:", error);
        });

      let currentFilter = 'all';
      let allTasks = [];
      let currentDraggedTask = null;
      let currentMonth = new Date().getMonth();
      let currentYear = new Date().getFullYear();
      let currentView = 'list'; // 'list' or 'calendar'
      let currentEditingTaskId = null;
      let attachedFile = null;

      // Check authentication state on page load
      onAuthStateChanged(auth, (user) => {
        console.log('Auth state changed, user:', user ? user.uid : 'No user');
        if (user) {
          // User is signed in
          showTodoSection();
          const userId = user.uid;
          document.getElementById('userEmail').textContent = user.email;
          const tasksRef = ref(database, `tasks/${userId}`);
          
          onValue(tasksRef, snapshot => {
            allTasks = [];
            if (snapshot.exists()) {
              snapshot.forEach(child => {
                allTasks.push({
                  id: child.key,
                  ...child.val()
                });
              });
            }
            renderTasks(allTasks);
            updateTaskStats(allTasks);
            if (currentView === 'calendar') {
              renderCalendar();
            }
          }, error => {
            document.getElementById('taskError').innerText = error.message;
            console.error('Error fetching tasks:', error);
          });
        } else {
          // User is signed out
          document.getElementById('authSection').style.display = 'block';
          document.getElementById('todoSection').style.display = 'none';
          document.getElementById('taskList').innerHTML = '';
          document.getElementById('taskError').innerText = '';
        }
      });

      // Dark Mode Toggle
      const themeToggle = document.getElementById('themeToggle');
      themeToggle.addEventListener('click', () => {
        const body = document.body;
        if (body.getAttribute('data-theme') === 'dark') {
          body.removeAttribute('data-theme');
          themeToggle.innerHTML = '<i class="fas fa-moon"></i>';
          localStorage.setItem('theme', 'light');
        } else {
          body.setAttribute('data-theme', 'dark');
          themeToggle.innerHTML = '<i class="fas fa-sun"></i>';
          localStorage.setItem('theme', 'dark');
        }
      });

      // Check for saved theme preference
      if (localStorage.getItem('theme') === 'dark') {
        document.body.setAttribute('data-theme', 'dark');
        themeToggle.innerHTML = '<i class="fas fa-sun"></i>';
      }

      // Authentication functions
      window.signUp = async function() {
        const email = document.getElementById('email').value.trim();
        const password = document.getElementById('password').value;
        const errorDisplay = document.getElementById('error');
        if (!email || !password) {
          errorDisplay.innerText = 'Please enter both email and password.';
          console.error('Sign-up: Missing email or password');
          return;
        }
        try {
          await createUserWithEmailAndPassword(auth, email, password);
          showTodoSection();
          console.log('Sign-up successful, email:', email);
        } catch (error) {
          errorDisplay.innerText = error.message;
          console.error('Sign-up error:', error);
        }
      };

      window.signIn = async function() {
        const email = document.getElementById('email').value.trim();
        const password = document.getElementById('password').value;
        const errorDisplay = document.getElementById('error');
        if (!email || !password) {
          errorDisplay.innerText = 'Please enter both email and password.';
          console.error('Sign-in: Missing email or password');
          return;
        }
        try {
          await signInWithEmailAndPassword(auth, email, password);
          showTodoSection();
          console.log('Sign-in successful, email:', email);
        } catch (error) {
          errorDisplay.innerText = error.message;
          console.error('Sign-in error:', error);
        }
      };

      window.signOut = async function() {
        try {
          await signOut(auth);
          document.getElementById('authSection').style.display = 'block';
          document.getElementById('todoSection').style.display = 'none';
          document.getElementById('taskList').innerHTML = '';
          document.getElementById('email').value = '';
          document.getElementById('password').value = '';
          document.getElementById('taskError').innerText = '';
          document.getElementById('error').innerText = '';
          console.log('Sign-out successful');
        } catch (error) {
          document.getElementById('error').innerText = error.message;
          console.error('Sign-out error:', error);
        }
      };

      // Show to-do section
      function showTodoSection() {
        document.getElementById('authSection').style.display = 'none';
        document.getElementById('todoSection').style.display = 'block';
        document.getElementById('error').innerText = '';
        document.getElementById('taskError').innerText = '';
        document.getElementById('userEmail').textContent = auth.currentUser.email;
        
        // Set today's date as default for due date
        const today = new Date().toISOString().split('T')[0];
        document.getElementById('dueDateInput').value = today;
      }

      // Add task
      window.addTask = async function() {
        const taskInput = document.getElementById('taskInput');
        const taskText = taskInput.value.trim();
        const priorityInput = document.getElementById('priorityInput');
        const priority = priorityInput.value;
        const dueDateInput = document.getElementById('dueDateInput');
        const dueDate = dueDateInput.value;
        const descriptionInput = document.getElementById('taskDescription');
        const description = descriptionInput.value.trim();
        const taskError = document.getElementById('taskError');
        
        console.log('Add Task clicked, taskText:', taskText, 'user:', auth.currentUser ? auth.currentUser.uid : 'No user');
        if (!auth.currentUser) {
          taskError.innerText = 'Please sign in to add tasks.';
          console.error('Add Task: No user logged in');
          return;
        }
        if (!taskText) {
          taskError.innerText = 'Task cannot be empty.';
          console.error('Add Task: Empty task input');
          return;
        }
        try {
          const userId = auth.currentUser.uid;
          const taskRef = ref(database, `tasks/${userId}`);
          
          let fileUrl = '';
          // Upload file if attached
          if (attachedFile) {
            const fileRef = storageRef(storage, `tasks/${userId}/${Date.now()}_${attachedFile.name}`);
            const snapshot = await uploadBytes(fileRef, attachedFile);
            fileUrl = await getDownloadURL(snapshot.ref);
          }
          
          const taskData = {
            text: taskText,
            completed: false,
            priority: priority,
            dueDate: dueDate,
            description: description,
            attachment: fileUrl,
            attachmentName: attachedFile ? attachedFile.name : '',
            timestamp: serverTimestamp(),
            order: allTasks.length // For drag and drop ordering
          };
          
          await push(taskRef, taskData);
          taskInput.value = '';
          descriptionInput.value = '';
          document.getElementById('filePreview').innerHTML = '';
          attachedFile = null;
          taskError.innerText = '';
          console.log('Task added successfully:', taskText);
        } catch (error) {
          taskError.innerText = error.message;
          console.error('Add Task error:', error);
        }
      };

      // File upload preview
      window.previewFile = function() {
        const fileInput = document.getElementById('fileInput');
        const filePreview = document.getElementById('filePreview');
        
        if (fileInput.files.length > 0) {
          attachedFile = fileInput.files[0];
          if (attachedFile.type.startsWith('image/')) {
            const reader = new FileReader();
            reader.onload = function(e) {
              filePreview.innerHTML = `<img src="${e.target.result}" alt="Preview" style="max-width: 100%; max-height: 200px;">`;
            };
            reader.readAsDataURL(attachedFile);
          } else {
            filePreview.innerHTML = `<div class="attachment-item">
              <i class="fas fa-file"></i>
              <span>${attachedFile.name}</span>
            </div>`;
          }
        }
      };

      // Search tasks
      window.searchTasks = function() {
        const searchTerm = document.getElementById('searchInput').value.toLowerCase();
        if (!searchTerm) {
          renderTasks(allTasks);
          return;
        }
        
        const filteredTasks = allTasks.filter(task => 
          task.text.toLowerCase().includes(searchTerm) || 
          (task.description && task.description.toLowerCase().includes(searchTerm))
        );
        
        renderTasks(filteredTasks);
      };

      // Change filter
      window.changeFilter = function(filter) {
        currentFilter = filter;
        
        // Update active button
        document.querySelectorAll('.filter-btn').forEach(btn => {
          btn.classList.remove('active');
        });
        event.target.classList.add('active');
        
        // Re-render tasks with new filter
        renderTasks(allTasks);
      };

      // Toggle calendar view
      window.toggleCalendarView = function() {
        const calendarView = document.getElementById('calendarView');
        if (currentView === 'list') {
          calendarView.style.display = 'block';
          currentView = 'calendar';
          renderCalendar();
          event.target.innerHTML = '<i class="fas fa-list"></i> List View';
        } else {
          calendarView.style.display = 'none';
          currentView = 'list';
          event.target.innerHTML = '<i class="fas fa-calendar"></i> Calendar View';
        }
      };

      // Render calendar
      function renderCalendar() {
        const calendarGrid = document.getElementById('calendarGrid');
        const monthNames = ["January", "February", "March", "April", "May", "June",
          "July", "August", "September", "October", "November", "December"
        ];
        
        document.getElementById('calendarMonth').textContent = `${monthNames[currentMonth]} ${currentYear}`;
        
        // Clear previous calendar
        calendarGrid.innerHTML = '';
        
        // Add day headers
        const days = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
        days.forEach(day => {
          const dayElement = document.createElement('div');
          dayElement.className = 'calendar-day day-header';
          dayElement.textContent = day;
          calendarGrid.appendChild(dayElement);
        });
        
        // Get first day of month and number of days
        const firstDay = new Date(currentYear, currentMonth, 1).getDay();
        const daysInMonth = new Date(currentYear, currentMonth + 1, 0).getDate();
        
        // Add empty cells for days before the first day of the month
        for (let i = 0; i < firstDay; i++) {
          const emptyDay = document.createElement('div');
          emptyDay.className = 'calendar-day';
          calendarGrid.appendChild(emptyDay);
        }
        
        // Add cells for each day of the month
        for (let day = 1; day <= daysInMonth; day++) {
          const dayElement = document.createElement('div');
          dayElement.className = 'calendar-day';
          dayElement.innerHTML = `<div>${day}</div>`;
          
          // Check if day has tasks
          const dateStr = `${currentYear}-${String(currentMonth + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
          const dayTasks = allTasks.filter(task => task.dueDate === dateStr);
          
          if (dayTasks.length > 0) {
            dayElement.classList.add('has-tasks');
            dayElement.innerHTML += `<span class="task-count">${dayTasks.length}</span>`;
          }
          
          // Add click event to show tasks for that day
          dayElement.addEventListener('click', () => {
            showTasksForDate(dateStr);
          });
          
          calendarGrid.appendChild(dayElement);
        }
      }

      // Show tasks for a specific date
      function showTasksForDate(dateStr) {
        const filteredTasks = allTasks.filter(task => task.dueDate === dateStr);
        renderTasks(filteredTasks);
        
        // Highlight selected date
        document.querySelectorAll('.calendar-day').forEach(day => {
          day.classList.remove('active');
        });
        event.target.classList.add('active');
      }

      // Navigate to previous month
      window.prevMonth = function() {
        currentMonth--;
        if (currentMonth < 0) {
          currentMonth = 11;
          currentYear--;
        }
        renderCalendar();
      }

      // Navigate to next month
      window.nextMonth = function() {
        currentMonth++;
        if (currentMonth > 11) {
          currentMonth = 0;
          currentYear++;
        }
        renderCalendar();
      }

      // Update task statistics
      function updateTaskStats(tasks) {
        const totalTasks = tasks.length;
        const completedTasks = tasks.filter(task => task.completed).length;
        const overdueTasks = tasks.filter(task => {
          if (task.completed || !task.dueDate) return false;
          const dueDate = new Date(task.dueDate);
          const today = new Date();
          today.setHours(0, 0, 0, 0);
          return dueDate < today;
        }).length;
        
        const productivityRate = totalTasks > 0 ? Math.round((completedTasks / totalTasks) * 100) : 0;
        
        document.getElementById('totalTasks').textContent = totalTasks;
        document.getElementById('completedTasks').textContent = completedTasks;
        document.getElementById('overdueTasks').textContent = overdueTasks;
        document.getElementById('productivityRate').textContent = `${productivityRate}%`;
      }

      // Render tasks based on current filter
      function renderTasks(tasks) {
        const taskList = document.getElementById('taskList');
        taskList.innerHTML = '';
        
        // Apply filter
        let filteredTasks = tasks;
        if (currentFilter === 'active') {
          filteredTasks = tasks.filter(task => !task.completed);
        } else if (currentFilter === 'completed') {
          filteredTasks = tasks.filter(task => task.completed);
        } else if (currentFilter === 'high') {
          filteredTasks = tasks.filter(task => task.priority === 'high');
        }
        
        // Sort by order (for drag and drop)
        filteredTasks.sort((a, b) => (a.order || 0) - (b.order || 0));
        
        if (filteredTasks.length === 0) {
          taskList.innerHTML = `
            <div class="empty-state">
              <i class="fas fa-clipboard-list"></i>
              <p>No tasks found</p>
            </div>
          `;
          return;
        }
        
        filteredTasks.forEach(task => {
          const li = document.createElement('li');
          li.setAttribute('data-id', task.id);
          li.draggable = true;
          
          // Add drag and drop event listeners
          li.addEventListener('dragstart', handleDragStart);
          li.addEventListener('dragover', handleDragOver);
          li.addEventListener('drop', handleDrop);
          li.addEventListener('dragend', handleDragEnd);
          
          // Color code by due date proximity
          if (task.dueDate && !task.completed) {
            const dueDate = new Date(task.dueDate);
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const timeDiff = dueDate.getTime() - today.getTime();
            const daysDiff = Math.ceil(timeDiff / (1000 * 3600 * 24));
            
            if (daysDiff < 0) {
              li.classList.add('due-date-proximity-urgent');
            } else if (daysDiff <= 2) {
              li.classList.add('due-date-proximity-soon');
            } else if (daysDiff <= 7) {
              li.classList.add('due-date-proximity-future');
            }
          }
          
          // Color code by priority
          if (task.priority === 'high') {
            li.style.borderLeftColor = '#d63031';
          } else if (task.priority === 'medium') {
            li.style.borderLeftColor = '#fdcb6e';
          } else {
            li.style.borderLeftColor = '#00b894';
          }
          
          if (task.completed) {
            li.classList.add('completed');
          }
          
          const formattedDate = task.dueDate ? new Date(task.dueDate).toLocaleDateString() : 'No due date';
          
          li.innerHTML = `
            <div>
              <input type="checkbox" ${task.completed ? 'checked' : ''} onchange="toggleTaskCompletion('${task.id}')" />
            </div>
            <div class="task-text">${task.text}</div>
            <div class="task-details">
              <div>${formattedDate}</div>
              <span class="task-priority priority-${task.priority}">${task.priority.toUpperCase()}</span>
            </div>
            <div class="task-actions">
              <button class="btn-warning" onclick="editTask('${task.id}')" title="Edit Task">
                <i class="fas fa-edit"></i>
              </button>
              <button class="btn-danger" onclick="deleteTask('${task.id}')" title="Delete Task">
                <i class="fas fa-trash"></i>
              </button>
            </div>
          `;
          
          taskList.appendChild(li);
        });
      }

      // Toggle task completion
      window.toggleTaskCompletion = async function(taskId) {
        try {
          const userId = auth.currentUser.uid;
          const taskRef = ref(database, `tasks/${userId}/${taskId}`);
          const task = allTasks.find(t => t.id === taskId);
          
          await update(taskRef, {
            completed: !task.completed
          });
          
          // Add animation effect
          const taskElement = document.querySelector(`li[data-id="${taskId}"]`);
          taskElement.classList.add('task-complete-animation');
          setTimeout(() => {
            taskElement.classList.remove('task-complete-animation');
          }, 500);
          
          console.log('Task completion toggled for task:', taskId);
        } catch (error) {
          document.getElementById('taskError').innerText = error.message;
          console.error('Toggle task completion error:', error);
        }
      };

      // Edit task
      window.editTask = function(taskId) {
        const task = allTasks.find(t => t.id === taskId);
        if (!task) return;
        
        // Populate the form with task details
        document.getElementById('taskInput').value = task.text;
        document.getElementById('dueDateInput').value = task.dueDate || '';
        document.getElementById('priorityInput').value = task.priority;
        document.getElementById('taskDescription').value = task.description || '';
        
        // Show file if exists
        const filePreview = document.getElementById('filePreview');
        if (task.attachment) {
          if (task.attachmentName.match(/\.(jpg|jpeg|png|gif)$/i)) {
            filePreview.innerHTML = `<img src="${task.attachment}" alt="Preview" style="max-width: 100%; max-height: 200px;">`;
          } else {
            filePreview.innerHTML = `<div class="attachment-item">
              <i class="fas fa-file"></i>
              <span>${task.attachmentName}</span>
            </div>`;
          }
          attachedFile = { name: task.attachmentName }; // Simulate file object
        } else {
          filePreview.innerHTML = '';
          attachedFile = null;
        }
        
        // Change button to "Update Task"
        const addButton = document.querySelector('.btn-accent');
        addButton.innerHTML = '<i class="fas fa-save"></i> Update Task';
        addButton.onclick = function() { updateTask(taskId); };
        
        // Scroll to form
        document.getElementById('taskInput').focus();
        currentEditingTaskId = taskId;
        
        console.log('Editing task:', taskId);
      };

      // Update task
      window.updateTask = async function(taskId) {
        const taskInput = document.getElementById('taskInput');
        const taskText = taskInput.value.trim();
        const priorityInput = document.getElementById('priorityInput');
        const priority = priorityInput.value;
        const dueDateInput = document.getElementById('dueDateInput');
        const dueDate = dueDateInput.value;
        const descriptionInput = document.getElementById('taskDescription');
        const description = descriptionInput.value.trim();
        const taskError = document.getElementById('taskError');
        
        if (!taskText) {
          taskError.innerText = 'Task cannot be empty.';
          return;
        }
        
        try {
          const userId = auth.currentUser.uid;
          const taskRef = ref(database, `tasks/${userId}/${taskId}`);
          
          let fileUrl = '';
          let fileName = '';
          
          // If a new file is attached, upload it
          if (attachedFile && attachedFile.name) {
            // Delete old file if exists
            const oldTask = allTasks.find(t => t.id === taskId);
            if (oldTask.attachment) {
              const oldFileRef = storageRef(storage, oldTask.attachment);
              try {
                await deleteObject(oldFileRef);
              } catch (error) {
                console.error('Error deleting old file:', error);
              }
            }
            
            // Upload new file
            const fileRef = storageRef(storage, `tasks/${userId}/${Date.now()}_${attachedFile.name}`);
            const snapshot = await uploadBytes(fileRef, attachedFile);
            fileUrl = await getDownloadURL(snapshot.ref);
            fileName = attachedFile.name;
          } else {
            // Keep existing file if no new file is attached
            const oldTask = allTasks.find(t => t.id === taskId);
            fileUrl = oldTask.attachment || '';
            fileName = oldTask.attachmentName || '';
          }
          
          await update(taskRef, {
            text: taskText,
            priority: priority,
            dueDate: dueDate,
            description: description,
            attachment: fileUrl,
            attachmentName: fileName
          });
          
          // Reset form
          taskInput.value = '';
          descriptionInput.value = '';
          document.getElementById('filePreview').innerHTML = '';
          attachedFile = null;
          taskError.innerText = '';
          
          // Change button back to "Add Task"
          const addButton = document.querySelector('.btn-accent');
          addButton.innerHTML = '<i class="fas fa-plus-circle"></i> Add Task';
          addButton.onclick = function() { addTask(); };
          
          currentEditingTaskId = null;
          console.log('Task updated successfully:', taskId);
        } catch (error) {
          taskError.innerText = error.message;
          console.error('Update task error:', error);
        }
      };

      // Delete task
      window.deleteTask = async function(taskId) {
        if (!confirm('Are you sure you want to delete this task?')) {
          return;
        }
        
        try {
          const userId = auth.currentUser.uid;
          const taskRef = ref(database, `tasks/${userId}/${taskId}`);
          
          // Delete attached file if exists
          const task = allTasks.find(t => t.id === taskId);
          if (task.attachment) {
            const fileRef = storageRef(storage, task.attachment);
            try {
              await deleteObject(fileRef);
            } catch (error) {
              console.error('Error deleting file:', error);
            }
          }
          
          await remove(taskRef);
          console.log('Task deleted successfully:', taskId);
        } catch (error) {
          document.getElementById('taskError').innerText = error.message;
          console.error('Delete task error:', error);
        }
      };

      // Drag and Drop functions
      function handleDragStart(e) {
        currentDraggedTask = this;
        this.classList.add('dragging');
        e.dataTransfer.effectAllowed = 'move';
        e.dataTransfer.setData('text/plain', this.getAttribute('data-id'));
      }

      function handleDragOver(e) {
        e.preventDefault();
        e.dataTransfer.dropEffect = 'move';
        return false;
      }

      function handleDrop(e) {
        e.preventDefault();
        if (currentDraggedTask !== this) {
          // Get task IDs
          const draggedTaskId = currentDraggedTask.getAttribute('data-id');
          const targetTaskId = this.getAttribute('data-id');
          
          // Find task indices
          const draggedIndex = allTasks.findIndex(task => task.id === draggedTaskId);
          const targetIndex = allTasks.findIndex(task => task.id === targetTaskId);
          
          if (draggedIndex !== -1 && targetIndex !== -1) {
            // Reorder tasks array
            const [movedTask] = allTasks.splice(draggedIndex, 1);
            allTasks.splice(targetIndex, 0, movedTask);
            
            // Update order in database
            updateTaskOrder();
          }
        }
        return false;
      }

      function handleDragEnd() {
        this.classList.remove('dragging');
      }

      // Update task order in database
      async function updateTaskOrder() {
        try {
          const userId = auth.currentUser.uid;
          
          for (let i = 0; i < allTasks.length; i++) {
            const taskRef = ref(database, `tasks/${userId}/${allTasks[i].id}`);
            await update(taskRef, {
              order: i
            });
          }
          
          console.log('Task order updated');
        } catch (error) {
          document.getElementById('taskError').innerText = error.message;
          console.error('Update task order error:', error);
        }
      }

      // Show task details in modal
      function showTaskDetails(taskId) {
        const task = allTasks.find(t => t.id === taskId);
        if (!task) return;
        
        const modalContent = document.getElementById('modalTaskContent');
        const formattedDate = task.dueDate ? new Date(task.dueDate).toLocaleDateString() : 'No due date';
        
        let attachmentHtml = '';
        if (task.attachment) {
          if (task.attachmentName.match(/\.(jpg|jpeg|png|gif)$/i)) {
            attachmentHtml = `<div class="attachment-item">
              <img src="${task.attachment}" alt="Attachment" style="max-width: 100%;">
            </div>`;
          } else {
            attachmentHtml = `<div class="attachment-item">
              <i class="fas fa-file"></i>
              <a href="${task.attachment}" target="_blank">${task.attachmentName}</a>
            </div>`;
          }
        }
        
        modalContent.innerHTML = `
          <h4>${task.text}</h4>
          <p><strong>Priority:</strong> <span class="task-priority priority-${task.priority}">${task.priority.toUpperCase()}</span></p>
          <p><strong>Due Date:</strong> ${formattedDate}</p>
          <p><strong>Description:</strong> ${task.description || 'No description'}</p>
          ${attachmentHtml}
        `;
        
        document.getElementById('taskDetailModal').style.display = 'flex';
      }

      // Close modal
      window.closeModal = function() {
        document.getElementById('taskDetailModal').style.display = 'none';
      }

      // Close modal if clicked outside
      window.onclick = function(event) {
        const modal = document.getElementById('taskDetailModal');
        if (event.target === modal) {
          closeModal();
        }
      }

    } catch (error) {
      console.error('Firebase initialization error:', error);
      document.getElementById('error').innerText = 'Failed to initialize the app. Please check your connection.';
    }
  </script>
</body>
</html>